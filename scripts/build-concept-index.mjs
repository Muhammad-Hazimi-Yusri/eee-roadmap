/**
 * build-concept-index.mjs
 *
 * Reads all concept domain files from content/concepts/ and generates:
 *   content/concepts/_index.yaml   ‚Äî reverse index: concept ID ‚Üí domain filename
 *   src/data/concept-library.json  ‚Äî all concepts with domain/tags, for future
 *                                    browser-side concept picker (Phase 5)
 *
 * Run via: node scripts/build-concept-index.mjs
 * Called automatically as part of: npm run build:data
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync, readdirSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import YAML from 'yaml';

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT         = join(__dirname, '..');
const CONCEPTS_DIR = join(ROOT, 'content', 'concepts');
const DATA_DIR     = join(ROOT, 'src', 'data');
const INDEX_PATH   = join(CONCEPTS_DIR, '_index.yaml');
const LIBRARY_PATH = join(DATA_DIR, 'concept-library.json');

function buildConceptIndex() {
  if (!existsSync(CONCEPTS_DIR)) {
    console.log('‚ö†Ô∏è  content/concepts/ not found ‚Äî skipping concept index build');
    return;
  }

  const domainFiles = readdirSync(CONCEPTS_DIR)
    .filter(f => f.endsWith('.yaml') && !f.startsWith('_'))
    .sort();

  if (domainFiles.length === 0) {
    console.log('‚ö†Ô∏è  No concept domain files found in content/concepts/');
    return;
  }

  console.log('üîÑ Building concept index...\n');

  // index: conceptId ‚Üí domain (for _index.yaml)
  const index = {};

  // library: array of { id, name, domain, tags, prerequisites, notes } (for concept-library.json)
  const library = [];

  let totalConcepts = 0;

  for (const filename of domainFiles) {
    const domain = filename.replace('.yaml', '');
    const raw    = readFileSync(join(CONCEPTS_DIR, filename), 'utf-8');
    const data   = YAML.parse(raw);

    const concepts = data.concepts ?? {};
    let count = 0;

    for (const [id, concept] of Object.entries(concepts)) {
      if (index[id]) {
        console.warn(`  ‚ö†Ô∏è  Duplicate concept ID "${id}" in ${filename} (already in ${index[id]})`);
      }

      index[id] = domain;

      library.push({
        id,
        name:          concept.name,
        domain,
        tags:          concept.tags         ?? [],
        prerequisites: concept.prerequisites ?? [],
        notes:         concept.notes        ?? null,
      });

      count++;
      totalConcepts++;
    }

    console.log(`  ‚úÖ ${filename}  (${count} concepts)`);
  }

  // Write _index.yaml
  const indexDoc = {
    _meta: {
      description: 'Auto-generated by build-concept-index.mjs ‚Äî do not edit manually',
      conceptCount: totalConcepts,
      domainCount:  domainFiles.length,
    },
    index,
  };

  writeFileSync(
    INDEX_PATH,
    '# EEE Roadmap ‚Äî Concept Index\n# Auto-generated ‚Äî do not edit. Re-run npm run build:data to regenerate.\n\n' +
    YAML.stringify(indexDoc, { lineWidth: 0 }),
    'utf-8'
  );

  // Write concept-library.json
  if (!existsSync(DATA_DIR)) mkdirSync(DATA_DIR, { recursive: true });
  writeFileSync(LIBRARY_PATH, JSON.stringify(library, null, 2), 'utf-8');

  console.log(`\n‚ú® Concept index built`);
  console.log(`   ${totalConcepts} concepts across ${domainFiles.length} domains`);
  console.log(`   ‚Üí content/concepts/_index.yaml`);
  console.log(`   ‚Üí src/data/concept-library.json\n`);
}

buildConceptIndex();
