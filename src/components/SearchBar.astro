<div class="search-wrapper">
  <button class="search-trigger" id="search-trigger" aria-label="Open search">
    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <span class="search-hint">Search tracks, topics, concepts...</span>
    <kbd class="search-shortcut">Ctrl K</kbd>
  </button>

  <div class="search-modal" id="search-modal">
    <div class="search-backdrop" id="search-backdrop"></div>
    <div class="search-container">
      <div class="search-input-wrapper">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="Search tracks, topics, concepts..."
          autocomplete="off"
        />
        <kbd class="search-esc">Esc</kbd>
      </div>
      <div class="search-results" id="search-results">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>
</div>

<script>
  import Fuse from 'fuse.js';
  import searchIndex from '../data/search-index.json';

  const trigger = document.getElementById('search-trigger')!;
  const modal = document.getElementById('search-modal')!;
  const backdrop = document.getElementById('search-backdrop')!;
  const input = document.getElementById('search-input') as HTMLInputElement;
  const resultsContainer = document.getElementById('search-results')!;

  // Fuse.js config - weighted by priority
  const fuse = new Fuse(searchIndex, {
    keys: [
      { name: 'name', weight: 0.6 },
      { name: 'description', weight: 0.2 },
      { name: 'content', weight: 0.15 },
      { name: 'track', weight: 0.03 },
      { name: 'topic', weight: 0.02 }
    ],
    threshold: 0.3,
    includeScore: true,
    includeMatches: true,
    ignoreLocation: true,
    useExtendedSearch: true,
    findAllMatches: true
  });

  function openSearch() {
    modal.classList.add('is-open');
    document.body.style.overflow = 'hidden';
    setTimeout(() => input.focus(), 50);
  }

  function closeSearch() {
    modal.classList.remove('is-open');
    input.value = '';
    resultsContainer.innerHTML = '';
    document.body.style.overflow = '';
  }

  function getSnippet(content: string, query: string, maxLength = 100): string | null {
    if (!content || !query) return null;
    
    const lowerContent = content.toLowerCase();
    const lowerQuery = query.toLowerCase();
    
    // Try exact match first
    let index = lowerContent.indexOf(lowerQuery);
    
    // Try matching first word if multi-word query
    if (index === -1 && query.includes(' ')) {
      const firstWord = lowerQuery.split(' ')[0];
      if (firstWord.length >= 3) {
        index = lowerContent.indexOf(firstWord);
      }
    }
    
    if (index === -1) return null;
    
    // Calculate context around match, respecting maxLength
    const contextBefore = Math.floor((maxLength - query.length) / 2);
    const contextAfter = maxLength - query.length - contextBefore;
    
    const start = Math.max(0, index - contextBefore);
    const end = Math.min(content.length, index + query.length + contextAfter);
    
    let snippet = content.slice(start, end).trim();
    
    // Add ellipsis
    if (start > 0) snippet = '...' + snippet;
    if (end < content.length) snippet = snippet + '...';
    
    // Escape HTML
    const escaped = snippet
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    
    // Highlight the matched term
    const highlighted = escaped.replace(
      new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'),
      '<mark class="search-highlight">$1</mark>'
    );
    
    return highlighted;
  }

  function renderResults(results: any[]) {
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="search-empty">No results found</div>';
      return;
    }

    const query = input.value.trim();

    // Sort: exact matches in name first, then by score
    results.sort((a, b) => {
      const aExact = a.item.name.toLowerCase().includes(query.toLowerCase());
      const bExact = b.item.name.toLowerCase().includes(query.toLowerCase());
      if (aExact && !bExact) return -1;
      if (!aExact && bExact) return 1;
      return (a.score || 0) - (b.score || 0);
    });

    // Group by type, respecting priority: track > topic > concept
    const grouped = { track: [], topic: [], concept: [] } as Record<string, any[]>;
    results.forEach(r => {
      const type = r.item.type as string;
      if (grouped[type]) grouped[type].push(r);
    });

    const html = Object.entries(grouped)
      .filter(([_, items]) => items.length > 0)
      .map(([type, items]) => `
        <div class="search-group">
          <div class="search-group-label">${type}s</div>
          ${items.slice(0, 5).map(r => {
            const item = r.item;
            const breadcrumb = type === 'track' 
              ? '' 
              : type === 'topic'
                ? item.track
                : `${item.track} â†’ ${item.topic}`;
            
            // Check which field matched
            const matchedFields = r.matches?.map((m: any) => m.key) || [];
            const matchedInNotes = matchedFields.includes('content') && !matchedFields.includes('name');
            
            // Get snippet if matched in notes
            const snippet = matchedInNotes ? getSnippet(item.content, query) : null;
            
            return `
              <a href="${item.path}" class="search-result">
                <div class="search-result-header">
                  <span class="search-result-name">${item.name}</span>
                  ${matchedInNotes ? '<span class="search-result-badge">in notes</span>' : ''}
                </div>
                ${breadcrumb ? `<span class="search-result-breadcrumb">${breadcrumb}</span>` : ''}
                ${snippet ? `<span class="search-result-snippet">${snippet}</span>` : ''}
              </a>
            `;
          }).join('')}
        </div>
      `).join('');

    resultsContainer.innerHTML = html;
  }

  // Event listeners
  trigger.addEventListener('click', openSearch);
  backdrop.addEventListener('click', closeSearch);

  input.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.trim();
    if (query.length < 2) {
      resultsContainer.innerHTML = '';
      return;
    }
    const results = fuse.search(query);
    renderResults(results);
  });

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    if (e.key === 'Escape') {
      closeSearch();
    }
  });
</script>

<style is:global>
  /* Trigger button in nav */
  .search-trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-muted);
    font-size: 0.8125rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }

  .search-trigger:hover {
    border-color: var(--color-text);
    color: var(--color-text);
  }

  .search-hint {
    font-size: 0.8125rem;
  }

  .search-shortcut {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6875rem;
    padding: 0.125rem 0.375rem;
    background: var(--color-border);
    border-radius: 3px;
  }

  /* Tablet: hide shortcut only */
  @media (max-width: 768px) {
    .search-shortcut {
      display: none;
    }
  }

  /* Mobile: shorter hint */
  @media (max-width: 480px) {
    .search-hint {
      display: none;
    }
    
    .search-trigger::after {
      content: 'Search...';
      font-size: 0.8125rem;
    }
  }

  /* Modal overlay */
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 10vh 1rem 1rem;
    visibility: hidden;
    opacity: 0;
    transition: visibility 0.2s, opacity 0.2s;
  }

  .search-modal.is-open {
    visibility: visible;
    opacity: 1;
  }

  .search-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
  }

  /* Search container */
  .search-container {
    position: relative;
    width: 100%;
    max-width: 560px;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3);
    transform: translateY(-10px);
    transition: transform 0.2s ease;
  }

  .search-modal.is-open .search-container {
    transform: translateY(0);
  }

  /* Input wrapper */
  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .search-input-wrapper .search-icon {
    flex-shrink: 0;
    color: var(--color-muted);
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    font-size: 1rem;
    color: var(--color-text);
    font-family: inherit;
  }

  .search-input::placeholder {
    color: var(--color-muted);
  }

  .search-esc {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6875rem;
    padding: 0.125rem 0.375rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 3px;
    color: var(--color-muted);
  }

  /* Results area */
  .search-results {
    max-height: 400px;
    overflow-y: auto;
  }

  .search-empty {
    padding: 2rem;
    text-align: center;
    color: var(--color-muted);
    font-size: 0.875rem;
  }

  /* Result groups */
  .search-group {
    padding: 0.5rem 0;
  }

  .search-group + .search-group {
    border-top: 1px solid var(--color-border);
    position: relative;
  }

  .search-group + .search-group::before {
    content: '';
    position: absolute;
    top: 0;
    left: 1rem;
    width: 6px;
    height: 6px;
    background: var(--color-copper, #b8860b);
    border-radius: 50%;
    transform: translateY(-50%);
  }

  .search-group + .search-group::after {
    content: '';
    position: absolute;
    top: 0;
    right: 1rem;
    width: 6px;
    height: 6px;
    background: var(--color-copper, #b8860b);
    border-radius: 50%;
    transform: translateY(-50%);
  }

  .search-group-label {
    padding: 0.375rem 1rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-muted);
  }

  /* Individual result */
  .search-result {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    padding: 0.625rem 1rem;
    text-decoration: none;
    color: var(--color-text);
    transition: background 0.15s;
  }

  .search-result:hover {
    background: var(--color-surface);
  }

  .search-result-name {
    font-size: 0.9375rem;
  }

  .search-result-breadcrumb {
    font-size: 0.75rem;
    color: var(--color-muted);
  }

  .search-result-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .search-result-badge {
    font-size: 0.625rem;
    font-family: 'IBM Plex Mono', monospace;
    padding: 0.125rem 0.375rem;
    background: var(--color-copper, #b8860b);
    color: #111;
    border-radius: 2px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .search-result-snippet {
    font-size: 0.75rem;
    color: var(--color-muted);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-highlight {
    background: var(--color-copper, #b8860b);
    color: #111;
    padding: 0 0.125rem;
    border-radius: 2px;
  }
</style>