---
// src/components/Roadmap.astro

import RoadmapSettings from './RoadmapSettings.astro';
import ConceptModal from './ConceptWindows.astro';
import { internalHref } from '../utils/url';
import { parseNotes } from '../utils/parseNotes';
import { wrapTermsInText } from '../utils/wrapGlossaryTerms';

interface Props {
  sections: import('../types/roadmap').RoadmapSection[];
  trackSlug: string;
}

const { sections, trackSlug } = Astro.props;

// Build concept data for windows (parse markdown at build time)
const conceptData: Record<string, Record<string, { notesHtml?: string }>> = {};
for (const section of sections) {
  for (const item of section.items) {
    if (item.concepts) {
      conceptData[item.id] = {};
      for (const concept of item.concepts) {
        conceptData[item.id][concept.name] = {
          notesHtml: concept.notes ? parseNotes(concept.notes) : undefined,
        };
      }
    }
  }
}
---
<RoadmapSettings />
<ConceptModal />

<script define:vars={{ conceptData, trackSlug }}>
  window.conceptData = conceptData;
  window.trackSlug = trackSlug;
</script>

<div class="roadmap">
  {sections.map((section) => (
    <div class="roadmap-section" id={section.id}>
      <h3 class="section-title">{section.title}</h3>
      
      <div class="roadmap-track">
        {section.items.map((item) => (
          <div 
            class={`roadmap-node ${item.optional ? 'roadmap-node--optional' : ''}`}
            id={item.id}
            data-node-id={item.id}
          >
            <button class="node-button" aria-expanded="false">
              <span class="node-dot"></span>
              <span class="node-title">{item.title}</span>
            </button>
            
            <div class="node-content" hidden>
              <p class="node-description" set:html={wrapTermsInText(item.description)} />

              {item.prerequisites && item.prerequisites.length > 0 && (
                <div class="node-prereqs">
                  <span class="prereqs-label">Prerequisites:</span>
                  {item.prerequisites.map((prereq) => {
                    const parts = prereq.split('/');
                    const isLinkable = parts.length >= 2;
                    if (isLinkable) {
                      const [track, id, ...displayParts] = parts;
                      const displayName = displayParts.length > 0 
                        ? displayParts.join('/') 
                        : id.replace(/-/g, ' ');
                      return (
                        <a 
                          href={internalHref(`roadmaps/${track}#${id}`)}
                          class="prereq prereq--link prereq-tag prereq-tag--link"
                          data-prereq-topic={id}
                        >
                          {displayName}
                        </a>
                      );
                    }
                    return (
                      <span 
                        class="prereq prereq--static prereq-tag prereq-tag--static"  
                        data-static-prereq={prereq}
                      >
                        {prereq}
                      </span>
                    );
                  })}
                </div>
              )}

              {item.outcomes && item.outcomes.length > 0 && (
                <div class="node-outcomes">
                  <span class="outcomes-label">You'll learn to:</span>
                  <ul class="outcomes-list">
                    {item.outcomes.map((outcome) => (
                      <li set:html={wrapTermsInText(outcome)} />
                    ))}
                  </ul>
                </div>
              )}

              {item.concepts && item.concepts.length > 0 && (
                <ul class="node-concepts">
                  {item.concepts.map((concept) => (
                    <li 
                      data-topic-id={item.id}
                      data-concept={concept.name}
                      class="pill concept-pill"
                    >{concept.name}</li>
                  ))}
                </ul>
              )}
              {item.resources && item.resources.length > 0 && (
              <div class="node-resources">
                <span class="resources-label">Resources:</span>
                {item.resources.map((r) => (
                  <a href={r.url} target="_blank" rel="noopener noreferrer" class="resource-link">{r.label}</a>
                ))}
              </div>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  ))}
</div>

<script>
  import { initRoadmapInteractions } from '../utils/roadmapInteractions';
  initRoadmapInteractions();
</script>
