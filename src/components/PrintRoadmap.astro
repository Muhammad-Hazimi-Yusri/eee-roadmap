---
import { parseNotes } from '../utils/parseNotes';
import { internalHref } from '../utils/url';
import type { RoadmapSection } from '../types/roadmap';

interface Props {
  sections: RoadmapSection[];
  trackSlug: string;
  title: string;
}

const { sections, trackSlug, title } = Astro.props;

// Pre-parse all concept notes at build time
const conceptNotesMap: Record<string, Record<string, string>> = {};
for (const section of sections) {
  for (const item of section.items) {
    if (item.concepts) {
      conceptNotesMap[item.id] = {};
      for (const concept of item.concepts) {
        if (concept.notes) {
          conceptNotesMap[item.id][concept.name] = parseNotes(concept.notes);
        }
      }
    }
  }
}

// Count totals
let totalTopics = 0;
let totalConcepts = 0;
for (const section of sections) {
  totalTopics += section.items.length;
  for (const item of section.items) {
    totalConcepts += item.concepts?.length ?? 0;
  }
}
---

<div class="print-page">
  <!-- Sidebar: checkbox tree -->
  <aside class="print-sidebar no-print">
    <a href={internalHref(`roadmaps/${trackSlug}`)} class="print-back-link">&larr; Back to track</a>

    <h2 class="print-sidebar-title">Print Mode</h2>

    <label class="print-tree-item print-tree-track">
      <input type="checkbox" data-select-all />
      <span>Select all</span>
    </label>

    <div class="print-tree">
      {sections.map((section) => (
        <div class="print-tree-section">
          <label class="print-tree-item print-tree-item--section">
            <input type="checkbox" data-section-check={section.id} />
            <span>{section.title}</span>
          </label>
          <div class="print-tree-children">
            {section.items.map((item) => (
              <div class="print-tree-topic">
                <label class="print-tree-item print-tree-item--topic">
                  <input
                    type="checkbox"
                    data-topic-check={item.id}
                    data-parent-section={section.id}
                  />
                  <span>{item.title}</span>
                </label>
                {item.concepts && item.concepts.length > 0 && (
                  <div class="print-tree-children">
                    {item.concepts.map((concept) => (
                      <label class="print-tree-item print-tree-item--concept">
                        <input
                          type="checkbox"
                          data-concept-check={`${item.id}:${concept.name}`}
                          data-parent-topic={item.id}
                          data-parent-section={section.id}
                        />
                        <span>{concept.name}</span>
                      </label>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>

    <div class="print-fields-section">
      <span class="print-fields-label">Show fields</span>
      <label class="print-tree-item"><input type="checkbox" data-field-toggle="description" checked /><span>Description</span></label>
      <label class="print-tree-item"><input type="checkbox" data-field-toggle="prerequisites" checked /><span>Prerequisites</span></label>
      <label class="print-tree-item"><input type="checkbox" data-field-toggle="outcomes" checked /><span>Outcomes</span></label>
      <label class="print-tree-item"><input type="checkbox" data-field-toggle="concepts" checked /><span>Concept Notes</span></label>
      <label class="print-tree-item"><input type="checkbox" data-field-toggle="resources" checked /><span>Resources</span></label>
    </div>

    <div class="print-fields-section">
      <span class="print-fields-label">Options</span>
      <label class="print-tree-item">
        <input type="checkbox" id="high-contrast-toggle" />
        <span>High contrast (no gray)</span>
      </label>
      <label class="print-tree-item">
        <input type="checkbox" id="section-breaks-toggle" />
        <span>New page per section</span>
      </label>
    </div>

    <div class="print-layout-toggle">
      <span class="print-fields-label">Layout</span>
      <label class="print-tree-item">
        <input type="radio" name="print-layout" value="normal" checked data-layout-radio />
        <span>Normal (A4)</span>
      </label>
      <label class="print-tree-item">
        <input type="radio" name="print-layout" value="two-col" data-layout-radio />
        <span>2-column (A4)</span>
      </label>
      <label class="print-tree-item">
        <input type="radio" name="print-layout" value="booklet-duplex" data-layout-radio />
        <span>Booklet A5 (double-sided)</span>
      </label>
      <label class="print-tree-item">
        <input type="radio" name="print-layout" value="booklet-single" data-layout-radio />
        <span>Booklet A5 (single-sided)</span>
      </label>
    </div>

    <button class="btn print-btn" id="print-btn">Print / Save as PDF</button>

    <div class="booklet-workflow" id="booklet-workflow" hidden>
      <div class="booklet-step-block">
        <span class="booklet-step-badge">1</span>
        <div class="booklet-step-body">
          <p class="booklet-step-text">Save your content as an A5 PDF first. In the print dialog, choose <strong>"Save as PDF"</strong>.</p>
          <button class="btn print-btn" id="booklet-save-btn">Save as A5 PDF</button>
        </div>
      </div>
      <div class="booklet-step-block">
        <span class="booklet-step-badge">2</span>
        <div class="booklet-step-body">
          <p class="booklet-step-text">Select the saved PDF below. It will be rearranged into booklet page order and downloaded automatically.</p>
          <label class="btn print-btn booklet-upload-label" id="booklet-upload-label">
            Select A5 PDF &rarr; Download Booklet
            <input type="file" accept=".pdf" id="booklet-file-input" hidden />
          </label>
        </div>
      </div>
      <div class="booklet-status" id="booklet-status"></div>
    </div>
  </aside>

  <!-- Preview area -->
  <main class="print-preview">
    <div class="print-header">
      <h1 class="print-title">{title}</h1>
      <p class="print-meta">
        {sections.length} sections &middot; {totalTopics} topics &middot; {totalConcepts} concepts
      </p>
      <p class="print-url">eee-roadmap.muhammadhazimiyusri.uk/roadmaps/{trackSlug}/</p>
    </div>

    <div class="print-empty-msg" id="print-empty-msg">
      Select items from the sidebar to preview them here.
    </div>

    <div id="print-content">
      {sections.map((section) => (
        <div class="print-section" data-print-section={section.id} hidden>
          <h2 class="print-section-title">{section.title}</h2>

          {section.items.map((item) => (
            <div class="print-topic" data-print-topic={item.id} hidden>
              <h3 class="print-topic-title">
                {item.title}
                {item.optional && <span class="print-optional-badge">optional</span>}
              </h3>
              <p class="print-description" data-print-field="description">{item.description}</p>

              {item.prerequisites && item.prerequisites.length > 0 && (
                <div class="print-field" data-print-field="prerequisites">
                  <span class="print-field-label">Prerequisites:</span>
                  <span class="print-field-value">
                    {item.prerequisites.map((p) => {
                      const parts = p.split('/');
                      return parts.length >= 2
                        ? (parts.length > 2 ? parts.slice(2).join('/') : parts[1].replace(/-/g, ' '))
                        : p;
                    }).join(', ')}
                  </span>
                </div>
              )}

              {item.outcomes && item.outcomes.length > 0 && (
                <div class="print-field" data-print-field="outcomes">
                  <span class="print-field-label">You'll learn to:</span>
                  <ul class="print-outcomes">
                    {item.outcomes.map((outcome) => (
                      <li>{outcome}</li>
                    ))}
                  </ul>
                </div>
              )}

              {item.concepts && item.concepts.length > 0 && (
                <div class="print-concepts-area" data-print-field="concepts">
                  {item.concepts.map((concept) => (
                    <div
                      class="print-concept"
                      data-print-concept={`${item.id}:${concept.name}`}
                      hidden
                    >
                      <span class="print-concept-name">{concept.name}</span>
                      {conceptNotesMap[item.id]?.[concept.name] && (
                        <div
                          class="print-concept-notes"
                          set:html={conceptNotesMap[item.id][concept.name]}
                        />
                      )}
                    </div>
                  ))}
                </div>
              )}

              {item.resources && item.resources.length > 0 && (
                <div class="print-field" data-print-field="resources">
                  <span class="print-field-label">Resources:</span>
                  <ul class="print-resources">
                    {item.resources.map((r) => (
                      <li>
                        <span class="print-resource-label">{r.label}</span>
                        <span class="print-resource-url">{r.url}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          ))}
        </div>
      ))}
    </div>
  </main>
</div>

<script>
  import { initPrintCheckboxes, initFieldToggles, initHighContrastToggle, initSectionBreaksToggle, initLayoutMode } from '../utils/printUtils';
  initPrintCheckboxes();
  initFieldToggles();
  initHighContrastToggle();
  initSectionBreaksToggle();
  initLayoutMode();
</script>

<style is:global>
  @import '../styles/print.css';
</style>
