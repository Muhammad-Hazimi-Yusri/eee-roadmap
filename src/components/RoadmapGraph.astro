---
/**
 * Interactive graph visualization of roadmap topics and prerequisites.
 * Uses Cytoscape.js with dagre layout.
 * Mobile: tap to open fullscreen modal.
 */
import { getTrackColorMap } from '../utils/trackColors';
import graphData from '../data/graph-data.json';

const trackSlugs = graphData.tracks.map((t: { slug: string }) => t.slug);
const colorMap = getTrackColorMap(trackSlugs);

// Pass data to client
const clientData = {
  nodes: graphData.nodes,
  edges: graphData.edges,
  tracks: graphData.tracks,
  colors: colorMap,
};
---

<!-- Desktop: inline graph -->
<div class="graph-wrapper">
  <div class="graph-container" id="roadmap-graph">
    <div class="graph-loading">Loading graph...</div>
  </div>
  
  <!-- Mobile tap hint -->
  <button class="graph-mobile-hint" id="graph-expand-btn" aria-label="Expand graph fullscreen">
    <span>Tap to explore</span>
  </button>
  
  <!-- Desktop fullscreen button -->
  <button class="graph-fullscreen-btn" id="graph-fullscreen-btn" aria-label="View fullscreen">
    ⛶
  </button>
</div>

<!-- Fullscreen modal -->
<div class="graph-modal" id="graph-modal" hidden>
  <div class="graph-modal-header">
    <span class="graph-modal-title">Topic Connections</span>
    <button class="graph-modal-close" id="graph-modal-close" aria-label="Close">✕</button>
  </div>
  <div class="graph-modal-container" id="roadmap-graph-modal"></div>
  <div class="graph-modal-hint">Pinch to zoom • Drag to pan • Tap topic to navigate</div>
</div>

<script define:vars={{ clientData }}>
  window.__graphData = clientData;
</script>

<script>
  import cytoscape from 'cytoscape';
  import dagre from 'cytoscape-dagre';

  cytoscape.use(dagre);

  function getGraphStyle(isDark: boolean) {
    return [
      {
        selector: 'node[type="track"]',
        style: {
          'background-color': 'data(color)',
          'background-opacity': isDark ? 0.25 : 0.15,
          'border-width': 2,
          'border-color': 'data(color)',
          'label': 'data(label)',
          'font-size': '14px',
          'font-weight': 'bold',
          'text-valign': 'top',
          'text-halign': 'center',
          'text-margin-y': -8,
          'padding': '25px',
          'color': isDark ? '#f8fafc' : '#1e293b',
          'text-background-color': isDark ? '#0f172a' : 'transparent',
          'text-background-opacity': isDark ? 0.8 : 0,
          'text-background-padding': '4px',
        },
      },
      {
        selector: 'node[type="topic"]',
        style: {
          'background-color': 'data(color)',
          'label': 'data(label)',
          'font-size': '9px',
          'text-valign': 'bottom',
          'text-halign': 'center',
          'text-margin-y': 5,
          'width': 22,
          'height': 22,
          'text-wrap': 'ellipsis',
          'text-max-width': '70px',
          'color': isDark ? '#e2e8f0' : '#1f2937',
          'text-background-color': isDark ? '#1e293b' : '#ffffff',
          'text-background-opacity': 0.85,
          'text-background-padding': '2px',
        },
      },
      {
        selector: 'edge',
        style: {
          'width': 1.2,
          'line-color': isDark ? '#64748b' : '#94a3b8',
          'target-arrow-color': isDark ? '#94a3b8' : '#64748b',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier',
          'arrow-scale': 0.7,
        },
      },
    ];
  }

  function buildElements(data: any) {
    const elements: any[] = [];

    for (const track of data.tracks) {
      elements.push({
        data: {
          id: `track:${track.slug}`,
          label: track.title,
          type: 'track',
          color: data.colors[track.slug],
        },
      });
    }

    for (const node of data.nodes) {
      elements.push({
        data: {
          id: node.id,
          label: node.label,
          parent: `track:${node.track}`,
          type: 'topic',
          track: node.track,
          color: data.colors[node.track],
        },
      });
    }

    for (const edge of data.edges) {
      elements.push({
        data: {
          source: edge.source,
          target: edge.target,
        },
      });
    }

    return elements;
  }

  function createGraph(container: HTMLElement, data: any) {
    const isDark = document.documentElement.classList.contains('dark');
    const cy = cytoscape({
      container,
      elements: buildElements(data),
      style: getGraphStyle(isDark) as any,
      layout: {
        name: 'dagre',
        rankDir: 'TB',
        nodeSep: 40,
        rankSep: 55,
        padding: 25,
      } as any,
      userZoomingEnabled: true,
      userPanningEnabled: true,
      boxSelectionEnabled: false,
    });

    // Click to navigate
    cy.on('tap', 'node[type="topic"]', (evt) => {
      const node = evt.target;
      const id = node.id();
      const [track, topicId] = id.split('/');
      window.location.href = `/roadmaps/${track}/#${topicId}`;
    });

    return cy;
  }

  function initGraph() {
    const container = document.getElementById('roadmap-graph');
    const data = (window as any).__graphData;
    if (!container || !data) return;

    container.innerHTML = '';
    createGraph(container, data);
  }

  function initModal() {
    const expandBtn = document.getElementById('graph-expand-btn');
    const fullscreenBtn = document.getElementById('graph-fullscreen-btn');
    const modal = document.getElementById('graph-modal') as HTMLElement | null;
    const modalContainer = document.getElementById('roadmap-graph-modal') as HTMLElement | null;
    const closeBtn = document.getElementById('graph-modal-close');
    const data = (window as any).__graphData;

    if (!modal || !modalContainer || !closeBtn || !data) return;

    let modalCy: any = null;

    function openModal() {
      modal!.hidden = false;
      document.body.style.overflow = 'hidden';

      if (!modalCy) {
        modalCy = createGraph(modalContainer!, data);
      } else {
        modalCy.resize();
        modalCy.fit();
      }
    }

    expandBtn?.addEventListener('click', openModal);
    fullscreenBtn?.addEventListener('click', openModal);

    closeBtn.addEventListener('click', () => {
      modal.hidden = true;
      document.body.style.overflow = '';
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.hidden) {
        modal.hidden = true;
        document.body.style.overflow = '';
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initGraph();
      initModal();
    });
  } else {
    initGraph();
    initModal();
  }
</script>

<style>
  .graph-wrapper {
    position: relative;
  }

  .graph-container {
    width: 100%;
    height: 400px;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    position: relative;
  }

  .graph-loading {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  /* Mobile hint overlay */
  .graph-mobile-hint {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    border: none;
    cursor: pointer;
    align-items: center;
    justify-content: center;
  }

  .graph-mobile-hint span {
    background: var(--color-bg);
    padding: 0.75rem 1.5rem;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    border: 2px solid var(--color-text);
  }

  @media (max-width: 768px) {
    .graph-container {
      height: 250px;
    }

    .graph-mobile-hint {
      display: flex;
    }
  }

  /* Fullscreen modal */
  .graph-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
  }

  .graph-modal[hidden] {
    display: none;
  }

  .graph-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .graph-modal-title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .graph-modal-close {
    background: none;
    border: 2px solid var(--color-text);
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--color-text);
  }

  .graph-modal-close:hover {
    background: var(--color-text);
    color: var(--color-bg);
  }

  .graph-modal-container {
    flex: 1;
    min-height: 0;
  }

  .graph-modal-hint {
    padding: 0.75rem;
    text-align: center;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    border-top: 1px solid var(--color-border);
  }

  /* Desktop fullscreen button */
  .graph-fullscreen-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 2rem;
    height: 2rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    cursor: pointer;
    font-size: 1rem;
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
    transition: opacity 0.15s;
  }

  .graph-fullscreen-btn:hover {
    opacity: 1;
    border-color: var(--color-text);
    color: var(--color-text);
  }

  @media (max-width: 768px) {
    .graph-fullscreen-btn {
      display: none;
    }
  }
</style>