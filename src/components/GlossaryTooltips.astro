---
// Client-side Tippy.js initialization for glossary links
import glossaryData from '../data/_glossary.json';

const { terms } = glossaryData;
---

<script is:inline define:vars={{ terms }}>
  window.__glossaryTerms = terms;
</script>

<script>
  import tippy from 'tippy.js';
  import 'tippy.js/dist/tippy.css';

  interface GlossaryTerm {
    id: string;
    term: string;
    acronyms?: string[];
    definition?: string;
  }
  
  const terms: GlossaryTerm[] = (window as any).__glossaryTerms || [];
  const termsMap = new Map<string, GlossaryTerm>(terms.map(t => [t.id, t]));

  function initTooltips() {
    document.querySelectorAll('.glossary-link').forEach(link => {
      const termId = (link as HTMLElement).dataset.termId;
      if (!termId) return;
      
      // Skip if already initialized
      if ((link as any)._tippy) return;
      
      const term = termsMap.get(termId);
      if (!term) return;
      
      // Build tooltip content
      const acronyms = term.acronyms?.length 
        ? `<span class="glossary-tip-acronyms">(${term.acronyms.join(', ')})</span>` 
        : '';
      
      // Truncate definition
      const defText = (term.definition || '')
        .replace(/<[^>]*>/g, '')
        .slice(0, 150)
        .trim() + ((term.definition?.length ?? 0) > 150 ? '...' : '');
      
      const content = `
        <div class="glossary-tip">
          <div class="glossary-tip-header">
            <strong>${term.term}</strong> ${acronyms}
          </div>
          <div class="glossary-tip-def">${defText}</div>
          <a href="/glossary/#${term.id}" class="glossary-tip-link" target="_blank" rel="noopener noreferrer">View in glossary â†’</a>
        </div>
      `;
      
      tippy(link as HTMLElement, {
        content,
        allowHTML: true,
        interactive: true,
        appendTo: document.body,
        placement: 'top',
        theme: 'glossary',
        maxWidth: 300,
        delay: [200, 0],
      });
    });
  }

  // Init on load
  initTooltips();
  
  // Re-init when windows open (for ConceptWindows)
  document.addEventListener('concept-window-opened', initTooltips);
</script>

<style is:global>
  /* Tippy tooltip theme */
  .tippy-box[data-theme~='glossary'] {
    background: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .tippy-box[data-theme~='glossary'] .tippy-arrow {
    color: var(--color-border);
  }

  .tippy-box[data-theme~='glossary'] .tippy-content {
    padding: 0;
  }

  .glossary-tip {
    padding: 0.75rem;
    font-size: 0.8125rem;
    line-height: 1.5;
  }

  .glossary-tip-header {
    margin-bottom: 0.375rem;
  }

  .glossary-tip-acronyms {
    color: var(--color-muted);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
  }

  .glossary-tip-def {
    color: var(--color-text);
    margin-bottom: 0.5rem;
  }

  .glossary-tip-link {
    display: inline-block;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6875rem;
    color: var(--color-copper);
    text-decoration: none;
  }

  .glossary-tip-link:hover {
    text-decoration: underline;
  }
</style>