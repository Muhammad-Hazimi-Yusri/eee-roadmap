---
// Client-side Tippy.js initialization for glossary links
import glossaryData from '../data/_glossary.json';

const { terms } = glossaryData;
---

<script is:inline define:vars={{ terms }}>
  window.__glossaryTerms = terms;
</script>

<script>
  import tippy from 'tippy.js';
  import 'tippy.js/dist/tippy.css';
  import katex from 'katex';
  import 'katex/dist/katex.min.css';

  interface GlossaryTerm {
    id: string;
    term: string;
    acronyms?: string[];
    definition?: string;
  }

  const terms: GlossaryTerm[] = (window as any).__glossaryTerms || [];
  const termsMap = new Map<string, GlossaryTerm>(terms.map(t => [t.id, t]));

  /**
   * Render LaTeX in a string, returning HTML
   */
  function renderLatex(text: string): string {
    if (!text) return '';
    
    // Replace block math $$...$$ 
    let result = text.replace(/\$\$([^$]+)\$\$/g, (_, math) => {
      try {
        return katex.renderToString(math.trim(), { displayMode: true, throwOnError: false });
      } catch {
        return `$$${math}$$`;
      }
    });
    
    // Replace inline math $...$
    result = result.replace(/\$([^$]+)\$/g, (_, math) => {
      try {
        return katex.renderToString(math.trim(), { displayMode: false, throwOnError: false });
      } catch {
        return `$${math}$`;
      }
    });
    
    return result;
  }

  /**
   * Truncate text while preserving HTML tags
   */
  function truncateHtml(html: string, maxLength: number): string {
    // Simple approach: truncate and add ellipsis if needed
    const textContent = html.replace(/<[^>]*>/g, '');
    if (textContent.length <= maxLength) return html;
    
    // Find a good cut point
    let count = 0;
    let cutIndex = 0;
    let inTag = false;
    
    for (let i = 0; i < html.length; i++) {
      if (html[i] === '<') inTag = true;
      else if (html[i] === '>') inTag = false;
      else if (!inTag) {
        count++;
        if (count >= maxLength) {
          cutIndex = i;
          break;
        }
      }
    }
    
    if (cutIndex === 0) cutIndex = html.length;
    return html.slice(0, cutIndex) + '...';
  }

  function initTooltips() {
    document.querySelectorAll('.glossary-link').forEach(link => {
      const termId = (link as HTMLElement).dataset.termId;
      if (!termId) return;
      
      // Skip if already initialized
      if ((link as any)._tippy) return;
      
      const term = termsMap.get(termId);
      if (!term) return;
      
      // Build tooltip content
      const acronyms = term.acronyms?.length 
        ? `<span class="glossary-tip-acronyms">(${term.acronyms.join(', ')})</span>` 
        : '';
      
      // Render LaTeX in definition
      const defRendered = renderLatex(term.definition || '');
      const defText = truncateHtml(defRendered, 200);
      
      const content = `
        <div class="glossary-tip">
          <div class="glossary-tip-header">
            <strong>${term.term}</strong> ${acronyms}
          </div>
          <div class="glossary-tip-def">${defText}</div>
          <a href="/glossary/#${term.id}" class="glossary-tip-link" target="_blank" rel="noopener noreferrer">View in glossary →</a>
        </div>
      `;
      
      tippy(link as HTMLElement, {
        content,
        allowHTML: true,
        interactive: true,
        appendTo: document.body,
        placement: 'top',
        theme: 'glossary',
        maxWidth: 320,
        delay: [200, 0],
      });
    });
  }

  // Init on load
  initTooltips();
  
  // Re-init when windows open (for ConceptWindows)
  document.addEventListener('concept-window-opened', initTooltips);
</script>

<style is:global>
  /* Tippy tooltip theme */
  .tippy-box[data-theme~='glossary'] {
    background: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgb(0 0 0 / 15%);
  }

  .tippy-box[data-theme~='glossary'] .tippy-arrow {
    color: var(--color-border);
  }

  .tippy-box[data-theme~='glossary'] .tippy-content {
    padding: 0;
  }

  .glossary-tip {
    padding: 0.75rem;
    font-size: 0.8125rem;
    line-height: 1.5;
  }

  .glossary-tip-header {
    margin-bottom: 0.375rem;
  }

  .glossary-tip-acronyms {
    color: var(--color-muted);
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .glossary-tip-def {
    color: var(--color-text);
    margin-bottom: 0.5rem;
  }

  .glossary-tip-link {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-copper);
    text-decoration: none;
  }

  .glossary-tip-link:hover {
    text-decoration: underline;
  }

  /* KaTeX in tooltips */
  .glossary-tip .katex {
    font-size: 0.95em;
  }

  .glossary-tip .katex-display {
    margin: 0.25em 0;
    overflow-x: auto;
  }
</style>
