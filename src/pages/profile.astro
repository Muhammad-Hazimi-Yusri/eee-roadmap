---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
import { getAllTracks, roadmaps } from '../data';

const baseUrl = import.meta.env.BASE_URL;

// Build track data for progress calculation
const tracksData = getAllTracks().map(({ slug, meta }) => {
  const sections = roadmaps[slug]?.sections ?? [];
  const conceptKeys: string[] = [];
  
  sections.forEach(section => {
    section.items.forEach(item => {
      item.concepts?.forEach(concept => {
        conceptKeys.push(`${item.id}:${concept.name}`);
      });
    });
  });
  
  return {
    slug,
    title: meta.title,
    icon: meta.icon,
    total: conceptKeys.length,
    keys: conceptKeys,
  };
});
---

<Layout title="Profile">
  <header class="profile-header">
    <div class="container flex items-center justify-between py-4">
      <a href={baseUrl} class="font-mono text-lg font-bold no-underline" style="color: var(--color-text);">
        ← EEE Roadmap
      </a>
      <a href={`${baseUrl}roadmaps/`} class="font-mono text-sm">
        roadmaps
      </a>
    </div>
  </header>

  <main class="profile-page">
    <div class="container py-12">
      <!-- User info section -->
      <section class="user-section" id="user-section">
        <div class="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <h1 class="user-name" id="user-name">Guest</h1>
            <p class="user-email" id="user-email">Progress saved locally</p>
          </div>
        </div>
        
        <!-- Sign-in prompt for guests -->
        <div class="signin-prompt" id="signin-prompt">
          <p>Sign in to sync your progress across devices</p>
          <button class="btn" id="profile-signin-btn">Sign in with Google</button>
        </div>
      </section>
      
      <!-- Progress section -->
      <section class="progress-section">
        <h2 class="section-title">Your Progress</h2>
        <div class="progress-overview" id="progress-overview">
          <!-- Total progress rendered by JS -->
        </div>
        <div class="progress-grid" id="progress-grid">
          <!-- Track cards rendered by JS -->
        </div>

        <!-- Data section -->
      <section class="data-section">
        <h2 class="section-title">Your Data</h2>
        <p class="text-muted mb-4" style="font-size: 0.875rem;">
          Export your progress to back it up or transfer to another device.
        </p>
        <div class="data-actions">
          <button class="btn" id="export-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export JSON
          </button>
          <label class="btn import-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Import JSON
            <input type="file" id="import-input" accept=".json" hidden />
          </label>
        </div>
        <p class="import-status" id="import-status"></p>
      </section>
      <!-- Import dialog -->
      <div class="import-dialog-backdrop" id="import-dialog" hidden>
        <div class="import-dialog">
          <h3 class="import-dialog-title">Import Progress</h3>
          <p class="import-dialog-info" id="import-dialog-info">Loading...</p>
          <div class="import-dialog-actions">
            <button class="btn" id="import-merge">Merge</button>
            <button class="btn" id="import-replace">Replace</button>
            <button class="btn import-cancel" id="import-cancel">Cancel</button>
          </div>
          <p class="import-dialog-hint">
            <strong>Merge:</strong> Add to existing progress<br>
            <strong>Replace:</strong> Overwrite completely
          </p>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script define:vars={{ tracksData, baseUrl }}>
  window.__tracksData = tracksData;
  window.__baseUrl = baseUrl;
</script>

<script>
  import { createIcons, icons } from 'lucide';
  import { supabase, isSupabaseConfigured } from '../lib/supabase';
  import { queueSync } from '../lib/sync';

  const tracksData = (window as any).__tracksData;
  const baseUrl = (window as any).__baseUrl;
  const STORAGE_KEY = 'eee-progress-v2';

  // DOM elements
  const avatarEl = document.getElementById('user-avatar');
  const nameEl = document.getElementById('user-name');
  const emailEl = document.getElementById('user-email');
  const signinPrompt = document.getElementById('signin-prompt');
  const signinBtn = document.getElementById('profile-signin-btn');
  const overviewEl = document.getElementById('progress-overview');
  const gridEl = document.getElementById('progress-grid');

  // Get progress from localStorage
  function getProgress(): { complete: string[]; important: string[] } {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : { complete: [], important: [] };
    } catch {
      return { complete: [], important: [] };
    }
  }

  // Update user section based on auth state
  async function updateUserSection() {
    if (!isSupabaseConfigured || !supabase) {
      // No Supabase - show guest state
      return;
    }

    const { data: { session } } = await supabase.auth.getSession();

    if (session) {
      const email = session.user.email || '';
      const name = email.split('@')[0] || 'User';
      const initial = name.charAt(0).toUpperCase();

      if (avatarEl) avatarEl.textContent = initial;
      if (nameEl) nameEl.textContent = name;
      if (emailEl) emailEl.textContent = email;
      if (signinPrompt) signinPrompt.classList.add('is-hidden');
    }
  }

  // Render progress cards
  function renderProgress() {
    const progress = getProgress();
    let totalComplete = 0;
    let totalConcepts = 0;

    // Calculate per-track progress
    const trackProgress = tracksData.map((track: any) => {
      const completed = track.keys.filter((k: string) => progress.complete.includes(k)).length;
      totalComplete += completed;
      totalConcepts += track.total;
      return {
        ...track,
        completed,
        percent: track.total > 0 ? Math.round((completed / track.total) * 100) : 0,
      };
    });

    // Render overview
    const overallPercent = totalConcepts > 0 ? Math.round((totalComplete / totalConcepts) * 100) : 0;
    if (overviewEl) {
      const emptyMessage = totalComplete === 0 
        ? `<p class="overview-hint">Start any track to begin your learning journey!</p>`
        : '';
        
      overviewEl.innerHTML = `
        <div class="overview-card">
          <div class="overview-stat">
            <span class="overview-number">${totalComplete}</span>
            <span class="overview-label">/ ${totalConcepts} concepts completed</span>
          </div>
          <div class="overview-bar">
            <div class="overview-bar-fill" style="width: ${overallPercent}%"></div>
          </div>
          <div class="overview-percent">${overallPercent}%</div>
          ${emptyMessage}
        </div>
      `;
    }

    // Render track cards
    if (gridEl) {
      gridEl.innerHTML = trackProgress.map((track: any) => `
        <a href="${baseUrl}roadmaps/${track.slug}/" class="track-card">
          <div class="track-header">
            <span class="track-title">
              <i data-lucide="${track.icon}" class="track-icon"></i>
              ${track.title}
            </span>
            <span class="track-stat">${track.completed}/${track.total}</span>
          </div>
          <div class="track-bar">
            <div class="track-bar-fill" style="width: ${track.percent}%"></div>
          </div>
          <div class="track-percent">${track.percent}% complete</div>
        </a>
      `).join('');

      // Render lucide icons in the newly created elements
      createIcons({ icons });
    }
  }

  // Sign in handler
  signinBtn?.addEventListener('click', async () => {
    if (!supabase) return;
    
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.href }
    });
    
    if (error) console.error('Login error:', error.message);
  });

  // Export/Import elements
  const exportBtn = document.getElementById('export-btn');
  const importInput = document.getElementById('import-input') as HTMLInputElement;
  const importStatus = document.getElementById('import-status');

  // Export progress as JSON
  exportBtn?.addEventListener('click', () => {
    const progress = getProgress();
    const data = {
      version: 1,
      exportedAt: new Date().toISOString(),
      progress,
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'eee-progress.json';
    a.click();
    
    URL.revokeObjectURL(url);
  });

  // Import dialog elements
  const importDialog = document.getElementById('import-dialog');
  const importDialogInfo = document.getElementById('import-dialog-info');
  const importMergeBtn = document.getElementById('import-merge');
  const importReplaceBtn = document.getElementById('import-replace');
  const importCancelBtn = document.getElementById('import-cancel');

  let pendingImportData: { complete: string[]; important: string[] } | null = null;

  // Import progress from JSON - show dialog
  importInput?.addEventListener('change', async () => {
    const file = importInput.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      // Validate structure
      if (!data.progress || !Array.isArray(data.progress.complete) || !Array.isArray(data.progress.important)) {
        throw new Error('Invalid file format');
      }

      // Store for dialog actions
      pendingImportData = data.progress;

      // Show info in dialog
      const completeCount = data.progress.complete.length;
      const importantCount = data.progress.important.length;
      
      if (importDialogInfo) {
        importDialogInfo.textContent = `Found: ${completeCount} completed, ${importantCount} highlighted`;
      }

      // Show dialog
      importDialog?.removeAttribute('hidden');

    } catch (err) {
      console.error('Import error:', err);
      if (importStatus) {
        importStatus.textContent = '✗ Invalid file. Please use an exported JSON file.';
        importStatus.className = 'import-status import-status--error';
      }
    }

    // Clear input for re-import
    importInput.value = '';
  });

  // Merge: add to existing
  importMergeBtn?.addEventListener('click', () => {
    if (!pendingImportData) return;

    const current = getProgress();
    const merged = {
      complete: [...new Set([...current.complete, ...pendingImportData.complete])],
      important: [...new Set([...current.important, ...pendingImportData.important])],
    };

    applyImport(merged, 'merged');
  });

  // Replace: overwrite completely
  importReplaceBtn?.addEventListener('click', () => {
    if (!pendingImportData) return;
    applyImport(pendingImportData, 'replaced');
  });

  // Cancel
  importCancelBtn?.addEventListener('click', () => {
    pendingImportData = null;
    importDialog?.setAttribute('hidden', '');
  });

  // Close on backdrop click
  importDialog?.addEventListener('click', (e) => {
    if (e.target === importDialog) {
      pendingImportData = null;
      importDialog.setAttribute('hidden', '');
    }
  });

  // Apply import (shared logic)
  function applyImport(progress: { complete: string[]; important: string[] }, action: string) {
    // Save to localStorage
    localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));

    // Sync to cloud if logged in
    if (isSupabaseConfigured) {
      queueSync();
    }

    // Update status
    if (importStatus) {
      importStatus.textContent = `✓ Progress ${action}: ${progress.complete.length} completed, ${progress.important.length} highlighted`;
      importStatus.className = 'import-status import-status--success';
    }

    // Hide dialog and re-render
    importDialog?.setAttribute('hidden', '');
    pendingImportData = null;
    renderProgress();
  }

  // Initialize
  updateUserSection();
  renderProgress();
</script>

<style is:global>
  .profile-header {
    border-bottom: 2px solid var(--color-text);
  }

  .user-section {
    margin-bottom: 3rem;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-left: 4px solid var(--color-copper);
    padding: 1.5rem;
  }

  .user-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 360px) {
    .user-card {
      flex-direction: column;
      text-align: center;
    }
  }

  .user-avatar {
    width: 4rem;
    height: 4rem;
    min-width: 4rem;
    border-radius: 50%;
    background: var(--color-copper);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    font-family: "IBM Plex Mono", monospace;
    flex-shrink: 0;
  }

  .user-name {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
  }

  .user-email {
    color: var(--color-text-muted);
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .user-info {
    overflow: hidden;
    min-width: 0;
  }

  .signin-prompt {
    background: var(--color-bg-grid);
    border: 1px dashed var(--color-border);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
  }

  @media (max-width: 480px) {
    .signin-prompt {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
    }
  }

  .signin-prompt.is-hidden {
    display: none;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .progress-overview {
    margin-bottom: 1.5rem;
  }

  .progress-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }

  @media (min-width: 640px) {
    .progress-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Overview card */
  .overview-card {
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-left: 4px solid var(--color-copper);
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .overview-stat {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .overview-number {
    font-family: "IBM Plex Mono", monospace;
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-copper);
  }

  .overview-label {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .overview-bar {
    height: 8px;
    background: var(--color-border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .overview-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-copper), #d4956a);
    border-radius: 4px;
    transition: width 0.3s ease;
  }

  .overview-percent {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-align: right;
  }

  /* Track cards */
  .track-card {
    display: block;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    padding: 1rem 1.25rem;
    text-decoration: none;
    color: var(--color-text);
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .track-card:hover {
    border-color: var(--color-copper);
    box-shadow: 0 2px 8px rgba(184, 115, 51, 0.15);
  }

  .track-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .track-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .track-icon {
    width: 1.125rem;
    height: 1.125rem;
    color: var(--color-copper);
    flex-shrink: 0;
  }

  .track-stat {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    color: var(--color-copper);
  }

  .track-bar {
    height: 6px;
    background: var(--color-border);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 0.5rem;
    position: relative;
  }

  /* Copper trace styling */
  .track-bar::before,
  .track-bar::after {
    content: '';
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    background: var(--color-bg);
    z-index: 1;
  }

  .track-bar::before {
    left: -5px;
  }

  .track-bar::after {
    right: -5px;
  }

  .track-bar-fill {
    height: 100%;
    background: var(--color-copper);
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .track-percent {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  /* Data section */
  .data-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px dashed var(--color-border);
  }

  .data-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  @media (max-width: 480px) {
    .data-actions {
      flex-direction: column;
    }
    
    .data-actions .btn {
      width: 100%;
      justify-content: center;
    }
  }

  .import-label {
    cursor: pointer;
  }

  .import-status {
    margin-top: 1rem;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
  }

  .import-status--success {
    color: var(--color-pcb);
  }

  .import-status--error {
    color: #c53030;
  }

  /* Import dialog */
  .import-dialog-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .import-dialog-backdrop[hidden] {
    display: none;
  }

  .import-dialog {
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    padding: 1.5rem;
    max-width: 400px;
    width: 90%;
  }

  .import-dialog-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0 0 1rem 0;
  }

  .import-dialog-info {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    background: var(--color-bg-grid);
    padding: 0.75rem;
    margin-bottom: 1rem;
  }

  .import-dialog-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .import-cancel {
    background: none;
    border-color: var(--color-text-muted);
    color: var(--color-text-muted);
  }

  .import-dialog-hint {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin: 0;
    line-height: 1.6;
  }

  .overview-hint {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px dashed var(--color-border);
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
</style>