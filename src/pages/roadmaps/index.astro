---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { internalHref } from '../../utils/url';
import { getAllTracks, roadmaps } from '../../data';
import * as LucideIcons from '@lucide/astro';

const allTracks = getAllTracks();

function getIcon(iconName: string) {
  const pascalName = iconName
    .split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join('');
  return (LucideIcons as any)[pascalName] || LucideIcons.HelpCircle;
}

// Prepare data for client-side
const tracksData = allTracks.map(({ slug, meta }) => ({
  slug,
  title: meta.title,
  description: meta.description,
  href: internalHref(`roadmaps/${slug}`),
  sections: (roadmaps[slug]?.sections ?? []).map(section => ({
    id: section.id,
    title: section.title,
    topics: section.items.map(item => ({ id: item.id, title: item.title }))
  }))
}));
---

<Layout title="All Tracks">
  <Header />
  <main class="pcb-page">
    <div class="container py-12">
      <h1 class="text-2xl font-bold mb-8">All Learning Tracks</h1>
      
      <div class="tracks-grid">
        {allTracks.map(({ slug, meta }) => {
          const IconComponent = getIcon(meta.icon);
          const sections = roadmaps[slug]?.sections ?? [];
          
          return (
            <article class="pcb-card" data-slug={slug}>
              <div class="pcb-card__inner">
                {/* Copper traces decoration */}
                <svg class="pcb-card__traces" viewBox="0 0 300 200" preserveAspectRatio="none">
                  <path d="M0,30 H20 V50 H40" />
                  <path d="M300,25 H280 V45 H260 V65" />
                  <path d="M30,200 V180 H50 V160" />
                  <path d="M270,200 V175 H250" />
                  <circle cx="20" cy="30" r="4" />
                  <circle cx="280" cy="25" r="4" />
                  <circle cx="30" cy="180" r="4" />
                  <circle cx="270" cy="175" r="4" />
                </svg>
                
                {/* Content */}
                <div class="pcb-card__content">
                  <div class="pcb-card__header">
                    <IconComponent class="pcb-card__icon" />
                    <span class="pcb-card__title">{meta.title}</span>
                  </div>
                  
                  <p class="pcb-card__desc">{meta.description}</p>
                  
                  <div class="pcb-card__meta">
                    <span class="pcb-card__stat">{sections.length} sections</span>
                    <span class="pcb-card__stat">
                      {sections.reduce((sum, s) => sum + s.items.length, 0)} topics
                    </span>
                  </div>

                  <div class="pcb-card__sections">
                    {sections.map((section, i) => (
                      <div class="pcb-card__section">
                        <span class="pcb-card__section-name">{section.title}</span>
                      </div>
                    ))}
                  </div>
                </div>
                
                {/* Corner vias */}
                <div class="pcb-via pcb-via--tl"></div>
                <div class="pcb-via pcb-via--tr"></div>
                <div class="pcb-via pcb-via--bl"></div>
                <div class="pcb-via pcb-via--br"></div>
              </div>
            </article>
          );
        })}
      </div>
    </div>

    {/* Modal */}
    <div class="pcb-modal-backdrop" id="modal-backdrop">
      <div class="pcb-modal" id="modal">
        <button class="pcb-modal__close" id="modal-close" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        
        <div class="pcb-modal__header">
          <span class="pcb-modal__icon" id="modal-icon"></span>
          <h2 class="pcb-modal__title" id="modal-title"></h2>
        </div>
        
        <p class="pcb-modal__desc" id="modal-desc"></p>
        
        <a class="pcb-modal__cta" id="modal-link" href="#">
          Open Roadmap
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
        
        <div class="pcb-modal__sections" id="modal-sections"></div>
        
        {/* Decorative elements */}
        <div class="pcb-modal__corner pcb-modal__corner--tl"></div>
        <div class="pcb-modal__corner pcb-modal__corner--tr"></div>
        <div class="pcb-modal__corner pcb-modal__corner--bl"></div>
        <div class="pcb-modal__corner pcb-modal__corner--br"></div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script define:vars={{ tracksData }}>
  window.tracksData = tracksData;
</script>

<script>
  interface TrackData {
    slug: string;
    title: string;
    description: string;
    href: string;
    sections: { id: string; title: string; topics: { id: string; title: string }[] }[];
  }
  
  const tracksData = (window as any).tracksData as TrackData[];
  
  const backdrop = document.getElementById('modal-backdrop')!;
  const modal = document.getElementById('modal')!;
  const modalClose = document.getElementById('modal-close')!;
  const modalTitle = document.getElementById('modal-title')!;
  const modalDesc = document.getElementById('modal-desc')!;
  const modalLink = document.getElementById('modal-link') as HTMLAnchorElement;
  const modalSections = document.getElementById('modal-sections')!;

  let activeCard: HTMLElement | null = null;

  function openModal(slug: string, cardEl: HTMLElement) {
    const data = tracksData.find(t => t.slug === slug);
    if (!data) return;

    activeCard = cardEl;
    
    // Populate modal
    modalTitle.textContent = data.title;
    modalDesc.textContent = data.description;
    modalLink.href = data.href;
    
    modalSections.innerHTML = data.sections.map(section => `
      <div class="pcb-modal__section">
        <h3 class="pcb-modal__section-title">${section.title}</h3>
        <ul class="pcb-modal__topics">
          ${section.topics.map(topic => `
            <li class="pcb-modal__topic">
              <span class="pcb-modal__topic-dot"></span>
              ${topic.title}
            </li>
          `).join('')}
        </ul>
      </div>
    `).join('');

    // Get card position for animation origin
    const rect = cardEl.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    modal.style.setProperty('--origin-x', `${centerX}px`);
    modal.style.setProperty('--origin-y', `${centerY}px`);
    
    // Show
    backdrop.classList.add('is-open');
    cardEl.classList.add('is-selected');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    backdrop.classList.remove('is-open');
    if (activeCard) {
      activeCard.classList.remove('is-selected');
      activeCard = null;
    }
    document.body.style.overflow = '';
  }

  // Card clicks
  document.querySelectorAll('.pcb-card').forEach(card => {
    card.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      // Don't open modal if clicking a link
      if (target.closest('a')) return;
      
      const slug = card.getAttribute('data-slug');
      if (slug) openModal(slug, card as HTMLElement);
    });
  });

  // Close handlers
  modalClose.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
</script>

<style>
  /* ==================== PAGE ==================== */
  .pcb-page {
    min-height: 100vh;
  }

  .tracks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  /* ==================== CARD ==================== */
  .pcb-card {
    perspective: 1000px;
    cursor: pointer;
  }

  .pcb-card__inner {
    position: relative;
    padding: 1.5rem;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    transition: 
      transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
      box-shadow 0.3s ease,
      border-color 0.2s ease;
    transform-style: preserve-3d;
  }

  .pcb-card:hover .pcb-card__inner {
    transform: translateY(-8px) rotateX(2deg);
    box-shadow: 
      0 20px 40px -10px rgba(0, 0, 0, 0.15),
      0 10px 20px -10px rgba(184, 115, 51, 0.1);
    border-color: var(--color-copper);
  }

  .pcb-card.is-selected .pcb-card__inner {
    transform: translateY(-12px) scale(1.02);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border-color: var(--color-copper);
  }

  /* Traces SVG */
  .pcb-card__traces {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    opacity: 0.15;
  }

  .pcb-card__traces path,
  .pcb-card__traces circle {
    fill: none;
    stroke: var(--color-copper);
    stroke-width: 2;
  }

  .pcb-card__traces circle {
    fill: var(--color-copper);
  }

  .pcb-card:hover .pcb-card__traces {
    opacity: 0.25;
  }

  /* Via holes */
  .pcb-via {
    position: absolute;
    width: 10px;
    height: 10px;
    border: 2px solid var(--color-copper);
    border-radius: 50%;
    background: var(--color-bg);
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  .pcb-via::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 3px;
    height: 3px;
    background: var(--color-copper);
    border-radius: 50%;
  }

  .pcb-via--tl { top: 10px; left: 10px; }
  .pcb-via--tr { top: 10px; right: 10px; }
  .pcb-via--bl { bottom: 10px; left: 10px; }
  .pcb-via--br { bottom: 10px; right: 10px; }

  .pcb-card:hover .pcb-via {
    opacity: 1;
  }

  /* Card content */
  .pcb-card__content {
    position: relative;
    z-index: 1;
  }

  .pcb-card__header {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    margin-bottom: 0.625rem;
  }

  .pcb-card__icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-copper);
    flex-shrink: 0;
  }

  .pcb-card__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .pcb-card__desc {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    line-height: 1.5;
    margin-bottom: 1rem;
  }

  .pcb-card__meta {
    display: flex;
    gap: 1rem;
  }

  .pcb-card__stat {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.6875rem;
    color: var(--color-copper);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .pcb-card__sections {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px dashed var(--color-border);
  }

  .pcb-card__section {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--color-text-muted);
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-grid);
    border: 1px solid var(--color-border);
  }

  /* ==================== MODAL ==================== */
  .pcb-modal-backdrop {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    visibility: hidden;
    transition: 
      background 0.3s ease,
      backdrop-filter 0.3s ease,
      visibility 0.3s;
  }

  .pcb-modal-backdrop.is-open {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    visibility: visible;
  }

  .pcb-modal {
    --origin-x: 50%;
    --origin-y: 50%;
    
    position: relative;
    width: 100%;
    max-width: 550px;
    max-height: 85vh;
    overflow-y: auto;
    background: var(--color-bg);
    border: 3px solid var(--color-copper);
    padding: 2rem;
    
    transform-origin: var(--origin-x) var(--origin-y);
    transform: scale(0.8) translateY(20px);
    opacity: 0;
    transition: 
      transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
      opacity 0.3s ease;
  }

  .pcb-modal-backdrop.is-open .pcb-modal {
    transform: scale(1) translateY(0);
    opacity: 1;
  }

  .pcb-modal__close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.5rem;
    background: none;
    border: 1px solid var(--color-border);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }

  .pcb-modal__close:hover {
    border-color: var(--color-copper);
    color: var(--color-copper);
  }

  .pcb-modal__header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    padding-right: 3rem;
  }

  .pcb-modal__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-text);
  }

  .pcb-modal__desc {
    color: var(--color-text-muted);
    font-size: 0.9375rem;
    line-height: 1.5;
    margin-bottom: 1.25rem;
  }

  .pcb-modal__cta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: var(--color-copper);
    color: white;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: background 0.2s, transform 0.2s;
  }

  .pcb-modal__cta:hover {
    background: color-mix(in srgb, var(--color-copper), black 15%);
    transform: translateX(4px);
  }

  .pcb-modal__sections {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .pcb-modal__section {
    padding-left: 1rem;
    border-left: 2px solid var(--color-copper);
  }

  .pcb-modal__section-title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text);
    margin: 0 0 0.5rem 0;
  }

  .pcb-modal__topics {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .pcb-modal__topic {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: var(--color-text-muted);
  }

  .pcb-modal__topic-dot {
    width: 6px;
    height: 6px;
    border: 1.5px solid var(--color-copper);
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Corner decorations */
  .pcb-modal__corner {
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: var(--color-copper);
    border-style: solid;
    opacity: 0.4;
  }

  .pcb-modal__corner--tl {
    top: 8px;
    left: 8px;
    border-width: 2px 0 0 2px;
  }

  .pcb-modal__corner--tr {
    top: 8px;
    right: 8px;
    border-width: 2px 2px 0 0;
  }

  .pcb-modal__corner--bl {
    bottom: 8px;
    left: 8px;
    border-width: 0 0 2px 2px;
  }

  .pcb-modal__corner--br {
    bottom: 8px;
    right: 8px;
    border-width: 0 2px 2px 0;
  }

  /* ==================== RESPONSIVE ==================== */
  @media (max-width: 640px) {
    .pcb-modal {
      padding: 1.5rem;
      max-height: 90vh;
    }

    .pcb-modal__title {
      font-size: 1.125rem;
    }
  }
</style>