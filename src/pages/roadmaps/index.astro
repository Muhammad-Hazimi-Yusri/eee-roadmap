---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { internalHref } from '../../utils/url';
import { getAllTracks, roadmaps } from '../../data';
import * as LucideIcons from '@lucide/astro';

const allTracks = getAllTracks();

function getIcon(iconName: string) {
  const pascalName = iconName
    .split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join('');
  return (LucideIcons as any)[pascalName] || LucideIcons.HelpCircle;
}

const tracksData = allTracks.map(({ slug, meta }) => ({
  slug,
  title: meta.title,
  description: meta.description,
  href: internalHref(`roadmaps/${slug}`),
  sections: (roadmaps[slug]?.sections ?? []).map(section => ({
    id: section.id,
    title: section.title,
    topics: section.items.map(item => ({ id: item.id, title: item.title }))
  }))
}));
---

<Layout title="All Tracks">
  <Header />
  <main class="tracks-page">
    <div class="container py-12">
      <h1 class="text-2xl font-bold mb-2">All Learning Tracks</h1>
      <p class="text-muted mb-8">Click a box to see what's inside</p>
      
      <div class="tracks-grid">
        {allTracks.map(({ slug, meta }) => {
          const IconComponent = getIcon(meta.icon);
          const sections = roadmaps[slug]?.sections ?? [];
          const topicCount = sections.reduce((sum, s) => sum + s.items.length, 0);
          
          return (
            <article class="box-card" data-slug={slug}>
              {/* Box lid (opens on hover) */}
              <div class="box-card__lid">
                <div class="box-card__lid-front">
                  <span class="box-card__fragile">⚡ FRAGILE</span>
                </div>
                <div class="box-card__lid-top"></div>
              </div>
              
              {/* Box base with PCB inside */}
              <div class="box-card__base">
                {/* PCB preview peeking out */}
                <div class="box-card__pcb-preview">
                  <div class="pcb-peek">
                    <div class="pcb-peek__traces"></div>
                  </div>
                </div>
                
                {/* Box content */}
                <div class="box-card__content">
                  <div class="box-card__header">
                    <IconComponent class="box-card__icon" />
                    <span class="box-card__title">{meta.title}</span>
                  </div>
                  
                  <p class="box-card__desc">{meta.description}</p>
                  
                  <div class="box-card__meta">
                    <span class="box-card__stat">{sections.length} sections</span>
                    <span class="box-card__stat">{topicCount} topics</span>
                  </div>
                  
                  <div class="box-card__sections">
                    {sections.map((section) => (
                      <span class="box-card__section">{section.title}</span>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* Tape strips */}
              <div class="box-card__tape box-card__tape--h"></div>
              <div class="box-card__tape box-card__tape--v"></div>
            </article>
          );
        })}
      </div>
    </div>

    {/* PCB Modal */}
    <div class="pcb-modal-backdrop" id="modal-backdrop">
      <div class="pcb-modal" id="modal">
        {/* Solder mask green background with traces */}
        <div class="pcb-modal__board">
          {/* Mounting holes */}
          <div class="pcb-hole pcb-hole--tl"></div>
          <div class="pcb-hole pcb-hole--tr"></div>
          <div class="pcb-hole pcb-hole--bl"></div>
          <div class="pcb-hole pcb-hole--br"></div>
          
          {/* Decorative traces */}
          <svg class="pcb-modal__traces" viewBox="0 0 600 400" preserveAspectRatio="none">
            <!-- Top left corner traces -->
            <path d="M0,40 H30 V60 H50 V40 H80" />
            <path d="M40,0 V25 H60 V45" />
            <!-- Top right -->
            <path d="M600,50 H570 V30 H540 V50 H510" />
            <path d="M550,0 V20 H530 V40" />
            <!-- Bottom left -->
            <path d="M0,360 H40 V340 H70" />
            <path d="M30,400 V370 H60" />
            <!-- Bottom right -->
            <path d="M600,350 H560 V370 H530" />
            <path d="M570,400 V380 H540 V360" />
            <!-- Random middle traces -->
            <path d="M100,200 H130 V180 H160 V200 H190" />
            <path d="M450,250 H480 V230 H510" />
          </svg>
          
          {/* Silkscreen content */}
          <div class="pcb-modal__silkscreen">
            <button class="pcb-modal__close" id="modal-close" aria-label="Close">×</button>
            
            <div class="pcb-modal__header">
              <div class="pcb-modal__chip">
                <span class="pcb-modal__chip-notch"></span>
                <span class="pcb-modal__chip-label" id="modal-title">Track Name</span>
              </div>
            </div>
            
            <p class="pcb-modal__desc" id="modal-desc"></p>
            
            <a class="pcb-modal__cta" id="modal-link" href="#">
              <span class="pcb-modal__cta-pad"></span>
              Open Roadmap →
              <span class="pcb-modal__cta-pad"></span>
            </a>
            
            <div class="pcb-modal__sections" id="modal-sections">
              <!-- Populated by JS -->
            </div>
            
            {/* Reference designator */}
            <div class="pcb-modal__refdes">
              <span>REV 0.13</span>
              <span>EEE-ROADMAP</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script define:vars={{ tracksData }}>
  window.tracksData = tracksData;
</script>

<script>
  interface TrackData {
    slug: string;
    title: string;
    description: string;
    href: string;
    sections: { id: string; title: string; topics: { id: string; title: string }[] }[];
  }
  
  const tracksData = (window as any).tracksData as TrackData[];
  
  const backdrop = document.getElementById('modal-backdrop')!;
  const modal = document.getElementById('modal')!;
  const modalClose = document.getElementById('modal-close')!;
  const modalTitle = document.getElementById('modal-title')!;
  const modalDesc = document.getElementById('modal-desc')!;
  const modalLink = document.getElementById('modal-link') as HTMLAnchorElement;
  const modalSections = document.getElementById('modal-sections')!;

  let activeCard: HTMLElement | null = null;

  function openModal(slug: string, cardEl: HTMLElement) {
    const data = tracksData.find(t => t.slug === slug);
    if (!data) return;

    activeCard = cardEl;
    
    modalTitle.textContent = data.title.toUpperCase();
    modalDesc.textContent = data.description;
    modalLink.href = data.href;
    
    modalSections.innerHTML = data.sections.map(section => `
      <div class="pcb-section">
        <div class="pcb-section__header">
          <span class="pcb-section__marker">◆</span>
          <h3 class="pcb-section__title">${section.title}</h3>
        </div>
        <div class="pcb-section__topics">
          ${section.topics.map((topic, i) => `
            <div class="pcb-topic">
              <span class="pcb-topic__designator">U${i + 1}</span>
              <span class="pcb-topic__name">${topic.title}</span>
              <span class="pcb-topic__pads">
                <span class="pcb-topic__pad"></span>
                <span class="pcb-topic__pad"></span>
              </span>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');

    const rect = cardEl.getBoundingClientRect();
    modal.style.setProperty('--origin-x', `${rect.left + rect.width / 2}px`);
    modal.style.setProperty('--origin-y', `${rect.top + rect.height / 2}px`);
    
    backdrop.classList.add('is-open');
    cardEl.classList.add('is-selected');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    backdrop.classList.remove('is-open');
    if (activeCard) {
      activeCard.classList.remove('is-selected');
      activeCard = null;
    }
    document.body.style.overflow = '';
  }

  document.querySelectorAll('.box-card').forEach(card => {
    card.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('a')) return;
      
      const slug = card.getAttribute('data-slug');
      if (slug) openModal(slug, card as HTMLElement);
    });
  });

  modalClose.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
</script>

<style>
  /* ==================== PAGE ==================== */
  .tracks-page {
    min-height: 100vh;
  }

  .tracks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
  }

  /* ==================== BOX CARD ==================== */
  .box-card {
    --box-color: #d4a574;
    --box-dark: #b8956a;
    --box-light: #e6c9a8;
    --tape-color: #c9a86c;
    
    position: relative;
    cursor: pointer;
    perspective: 800px;
  }

  .box-card__base {
    position: relative;
    background: linear-gradient(145deg, var(--box-light) 0%, var(--box-color) 50%, var(--box-dark) 100%);
    border: 2px solid var(--box-dark);
    padding: 1.5rem;
    padding-top: 2rem;
    min-height: 200px;
    transition: box-shadow 0.3s ease;
  }

  .box-card:hover .box-card__base {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  }

  /* Lid */
  .box-card__lid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    z-index: 10;
    transform-style: preserve-3d;
    transform-origin: top center;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .box-card:hover .box-card__lid {
    transform: rotateX(-95deg);
  }

  .box-card__lid-front {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(180deg, var(--box-light) 0%, var(--box-color) 100%);
    border: 2px solid var(--box-dark);
    border-bottom: none;
    display: flex;
    align-items: center;
    justify-content: center;
    backface-visibility: hidden;
  }

  .box-card__lid-top {
    position: absolute;
    bottom: 100%;
    left: -2px;
    right: -2px;
    height: 20px;
    background: var(--box-color);
    border: 2px solid var(--box-dark);
    border-bottom: none;
    transform-origin: bottom center;
    transform: rotateX(90deg);
  }

  .box-card__fragile {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.625rem;
    font-weight: 700;
    color: #c0392b;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: #fff3cd;
    padding: 0.125rem 0.5rem;
    border: 1px dashed #c0392b;
  }

  /* Tape */
  .box-card__tape {
    position: absolute;
    background: var(--tape-color);
    opacity: 0.7;
    z-index: 11;
    pointer-events: none;
  }

  .box-card__tape--h {
    top: 30px;
    left: 20%;
    right: 20%;
    height: 24px;
    background: repeating-linear-gradient(
      90deg,
      var(--tape-color),
      var(--tape-color) 10px,
      transparent 10px,
      transparent 12px
    );
  }

  .box-card__tape--v {
    top: 18px;
    left: 50%;
    width: 20px;
    height: 45px;
    transform: translateX(-50%);
    background: var(--tape-color);
  }

  .box-card:hover .box-card__tape {
    opacity: 0.3;
  }

  /* PCB Preview (peeking out) */
  .box-card__pcb-preview {
    position: absolute;
    top: 0;
    left: 10%;
    right: 10%;
    height: 30px;
    overflow: hidden;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s;
  }

  .box-card:hover .box-card__pcb-preview {
    opacity: 1;
    transform: translateY(0);
  }

  .pcb-peek {
    height: 60px;
    background: #1a5c38;
    border: 2px solid #0d4028;
    border-radius: 2px;
  }

  .pcb-peek__traces {
    height: 100%;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 8px,
      #b8860b 8px,
      #b8860b 9px
    );
    opacity: 0.3;
  }

  /* Box content */
  .box-card__content {
    position: relative;
    z-index: 1;
  }

  .box-card__header {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    margin-bottom: 0.5rem;
  }

  .box-card__icon {
    width: 1.25rem;
    height: 1.25rem;
    color: #5d4e37;
    flex-shrink: 0;
  }

  .box-card__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 1rem;
    font-weight: 700;
    color: #3d2e1f;
  }

  .box-card__desc {
    font-size: 0.8125rem;
    color: #5d4e37;
    line-height: 1.5;
    margin-bottom: 0.75rem;
  }

  .box-card__meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .box-card__stat {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.6875rem;
    color: #8b7355;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .box-card__sections {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding-top: 0.75rem;
    border-top: 1px dashed #b8956a;
  }

  .box-card__section {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.5625rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #5d4e37;
    padding: 0.1875rem 0.375rem;
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid #b8956a;
  }

  /* ==================== PCB MODAL ==================== */
  .pcb-modal-backdrop {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: rgba(0, 0, 0, 0);
    visibility: hidden;
    transition: background 0.3s ease, visibility 0.3s;
  }

  .pcb-modal-backdrop.is-open {
    background: rgba(0, 0, 0, 0.7);
    visibility: visible;
  }

  .pcb-modal {
    --origin-x: 50%;
    --origin-y: 50%;
    
    width: 100%;
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
    transform: scale(0.7) rotateX(20deg);
    opacity: 0;
    transition: 
      transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
      opacity 0.3s ease;
  }

  .pcb-modal-backdrop.is-open .pcb-modal {
    transform: scale(1) rotateX(0deg);
    opacity: 1;
  }

  /* The actual PCB board */
  .pcb-modal__board {
    --pcb-green: #1a5c38;
    --pcb-green-light: #228b4a;
    --pcb-copper: #b8860b;
    --pcb-gold: #daa520;
    --pcb-silkscreen: #f5f5f0;
    
    position: relative;
    background: var(--pcb-green);
    border: 3px solid #0d4028;
    border-radius: 4px;
    padding: 1.5rem;
    box-shadow: 
      0 4px 8px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Mounting holes */
  .pcb-hole {
    position: absolute;
    width: 14px;
    height: 14px;
    border: 3px solid var(--pcb-copper);
    border-radius: 50%;
    background: #111;
  }

  .pcb-hole::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 6px;
    height: 6px;
    background: #333;
    border-radius: 50%;
  }

  .pcb-hole--tl { top: 8px; left: 8px; }
  .pcb-hole--tr { top: 8px; right: 8px; }
  .pcb-hole--bl { bottom: 8px; left: 8px; }
  .pcb-hole--br { bottom: 8px; right: 8px; }

  /* Traces SVG */
  .pcb-modal__traces {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .pcb-modal__traces path {
    fill: none;
    stroke: var(--pcb-copper);
    stroke-width: 2.5;
    opacity: 0.5;
  }

  /* Silkscreen layer */
  .pcb-modal__silkscreen {
    position: relative;
    z-index: 1;
    color: var(--pcb-silkscreen);
  }

  .pcb-modal__close {
    position: absolute;
    top: 0;
    right: 0;
    width: 32px;
    height: 32px;
    background: var(--pcb-copper);
    border: none;
    color: #111;
    font-size: 1.25rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }

  .pcb-modal__close:hover {
    background: var(--pcb-gold);
  }

  /* Chip header */
  .pcb-modal__header {
    margin-bottom: 1rem;
    padding-right: 2.5rem;
  }

  .pcb-modal__chip {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    background: #111;
    padding: 0.5rem 1rem;
    border: 1px solid #333;
    position: relative;
  }

  .pcb-modal__chip::before,
  .pcb-modal__chip::after {
    content: '';
    position: absolute;
    left: -6px;
    width: 4px;
    height: 8px;
    background: var(--pcb-copper);
  }

  .pcb-modal__chip::before { top: 25%; }
  .pcb-modal__chip::after { bottom: 25%; }

  .pcb-modal__chip-notch {
    width: 8px;
    height: 8px;
    border: 2px solid #444;
    border-radius: 50%;
    background: #222;
  }

  .pcb-modal__chip-label {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.1em;
  }

  .pcb-modal__desc {
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
    opacity: 0.9;
  }

  /* CTA button as a component */
  .pcb-modal__cta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--pcb-copper);
    color: #111;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: background 0.2s, transform 0.2s;
  }

  .pcb-modal__cta:hover {
    background: var(--pcb-gold);
    transform: translateY(-2px);
  }

  .pcb-modal__cta-pad {
    width: 6px;
    height: 6px;
    background: #111;
    border-radius: 1px;
  }

  /* Sections */
  .pcb-modal__sections {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .pcb-section {
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.2);
  }

  .pcb-section__header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .pcb-section__marker {
    color: var(--pcb-copper);
    font-size: 0.625rem;
  }

  .pcb-section__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    color: var(--pcb-silkscreen);
  }

  .pcb-section__topics {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  /* Topic as IC chip */
  .pcb-topic {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: #111;
    border: 1px solid #333;
    font-size: 0.75rem;
  }

  .pcb-topic__designator {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.5625rem;
    color: var(--pcb-copper);
    min-width: 24px;
  }

  .pcb-topic__name {
    flex: 1;
    color: var(--pcb-silkscreen);
    font-size: 0.75rem;
  }

  .pcb-topic__pads {
    display: flex;
    gap: 2px;
  }

  .pcb-topic__pad {
    width: 4px;
    height: 8px;
    background: var(--pcb-copper);
  }

  /* Reference designator */
  .pcb-modal__refdes {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.5625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.5;
  }

  /* ==================== DARK MODE ==================== */
  :global(.dark) .box-card {
    --box-color: #8b7355;
    --box-dark: #6b5544;
    --box-light: #a08060;
    --tape-color: #9a8050;
  }

  :global(.dark) .box-card__title { color: #2d1f0f; }
  :global(.dark) .box-card__desc { color: #4d3e2f; }
  :global(.dark) .box-card__icon { color: #4d3e2f; }

  /* ==================== RESPONSIVE ==================== */
  @media (max-width: 640px) {
    .tracks-grid {
      gap: 1.5rem;
    }

    .pcb-modal {
      max-height: 90vh;
    }

    .pcb-modal__board {
      padding: 1rem;
    }
  }
</style>