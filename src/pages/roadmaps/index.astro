---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProgressFilter from '../../components/ProgressFilter.astro';
import { internalHref } from '../../utils/url';
import { getAllTracks, roadmaps } from '../../data';
import * as LucideIcons from '@lucide/astro';
import { Check } from '@lucide/astro';
import pkg from '../../../package.json';


const VERSION = pkg.version;  

const allTracks = getAllTracks();

// Get unique categories
const categories = [...new Set(allTracks.map(t => t.meta.category))].sort();

function getIcon(iconName: string) {
  const pascalName = iconName
    .split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join('');
  return (LucideIcons as any)[pascalName] || LucideIcons.HelpCircle;
}

const tracksData = allTracks.map(({ slug, meta }) => ({
  slug,
  title: meta.title,
  description: meta.description,
  href: internalHref(`roadmaps/${slug}`),
  sections: (roadmaps[slug]?.sections ?? []).map(section => ({
    id: section.id,
    title: section.title,
    topics: section.items.map(item => ({ id: item.id, title: item.title }))
  }))
}));

  
// Helper: get all concept keys for a track
function getConceptKeys(slug: string): string[] {
  const roadmap = roadmaps[slug];
  if (!roadmap?.sections) return [];
  
  const keys: string[] = [];
  for (const section of roadmap.sections) {
    for (const item of section.items || []) {
      for (const concept of item.concepts || []) {
        keys.push(`${item.id}:${concept.name}`);
      }
    }
  }
  return keys;
}
---

<Layout title="All Tracks">
  <Header />
  <main class="tracks-page">
    <div class="container py-12">
      <h1 class="text-2xl font-bold mb-2">All Learning Tracks</h1>
      <p class="tracks-instruction text-muted mb-8">
        <span class="instruction-desktop">Click a box to see what's inside</span>
        <span class="instruction-mobile">Double-tap a box to see what's inside</span>
      </p>

      <div class="view-controls">
        <div class="view-toggle">
          <button class="view-toggle-btn view-toggle-btn--active" data-view="boxed" id="view-boxed" title="Compact card view">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
              <path d="m3.3 7 8.7 5 8.7-5"/>
              <path d="M12 22V12"/>
            </svg>
            Boxed
          </button>
          <button class="view-toggle-btn" data-view="unboxed" id="view-unboxed" title="Expanded PCB view with sections">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect width="18" height="18" x="3" y="3" rx="2"/>
              <path d="M3 9h18"/>
              <path d="M9 21V9"/>
            </svg>
            Unboxed
          </button>
        </div>
        <span class="view-hint" id="view-hint">Unbox box by clicking to preview contents</span>
      </div>

      <div class="filter-section">
        <span class="filter-section__label">Filter by Category</span>
        <div class="filter-bar" id="filter-bar">
          <button class="filter-label filter-label--active" data-category="all">
            <span class="filter-label__stamp"><Check size={14} stroke-width={3} /></span>
            <span class="filter-label__text">All</span>
            <span class="filter-label__via filter-label__via--tl"></span>
            <span class="filter-label__via filter-label__via--br"></span>
          </button>
          {categories.map(cat => (
            <button class="filter-label" data-category={cat}>
              <span class="filter-label__stamp"><Check size={14} stroke-width={3} /></span>
              <span class="filter-label__text">{cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
              <span class="filter-label__via filter-label__via--tl"></span>
              <span class="filter-label__via filter-label__via--br"></span>
            </button>
          ))}
        </div>
      </div>

      <ProgressFilter />
      
      <div class="tracks-grid">
        {allTracks.map(({ slug, meta }) => {
          const IconComponent = getIcon(meta.icon);
          const sections = roadmaps[slug]?.sections ?? [];
          const topicCount = sections.reduce((sum, s) => sum + s.items.length, 0);
          
          return (
            <article 
              class="box-card"
              data-track={slug}
              data-category={meta.category}
              data-concept-keys={JSON.stringify(getConceptKeys(slug))}
            >
              {/* Box lid (opens on hover) */}
              <div class="box-card__lid">
                <div class="box-card__lid-front">
                  <span class="box-card__label box-card__label--unverified">⚠ UNVERIFIED</span>
                </div>
                <div class="box-card__lid-top"></div>
              </div>
              
              {/* Box base with PCB inside */}
              <div class="box-card__base">
                {/* PCB preview peeking out */}
                <div class="box-card__pcb-preview">
                  <div class="pcb-peek">
                    <div class="pcb-peek__traces"></div>
                  </div>
                </div>
                
                {/* Box content */}
                <div class="box-card__content">
                  <div class="box-card__header">
                    <IconComponent class="box-card__icon" />
                    <span class="box-card__title">{meta.title}</span>
                  </div>
                  
                  <p class="box-card__desc">{meta.description}</p>
                  
                  <div class="box-card__meta">
                    <span class="box-card__stat">{sections.length} sections</span>
                    <span class="box-card__stat">{topicCount} topics</span>
                  </div>
                  
                  <div class="box-card__sections">
                    {sections.map((section) => (
                      <span class="box-card__section">{section.title}</span>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* Tape strips */}
              <div class="box-card__tape box-card__tape--h"></div>
              <div class="box-card__tape box-card__tape--v"></div>
              
              {/* Unboxed PCB view */}
              <div class="box-card__pcb">
                <div class="box-card__pcb-board">
                  {/* Decorative traces */}
                  <svg class="box-card__pcb-traces" viewBox="0 0 300 400" preserveAspectRatio="none">
                    {/* Corner traces */}
                    <path d="M0,20 H15 L25,30 V50" stroke="#b8860b" stroke-width="2" fill="none" opacity="0.4"/>
                    <path d="M0,40 H10 L20,50" stroke="#b8860b" stroke-width="1.5" fill="none" opacity="0.3"/>
                    <path d="M300,25 H280 L270,35 V55" stroke="#b8860b" stroke-width="2" fill="none" opacity="0.4"/>
                    <path d="M300,50 H285 L275,60" stroke="#b8860b" stroke-width="1.5" fill="none" opacity="0.3"/>
                    <path d="M20,400 V380 L30,370 H50" stroke="#b8860b" stroke-width="2" fill="none" opacity="0.4"/>
                    <path d="M280,400 V385 L270,375 H250" stroke="#b8860b" stroke-width="2" fill="none" opacity="0.4"/>
                    {/* Vias */}
                    <circle cx="25" cy="30" r="4" fill="#b8860b" opacity="0.5"/>
                    <circle cx="25" cy="30" r="1.5" fill="#0d4028" opacity="0.8"/>
                    <circle cx="270" cy="35" r="4" fill="#b8860b" opacity="0.5"/>
                    <circle cx="270" cy="35" r="1.5" fill="#0d4028" opacity="0.8"/>
                    <circle cx="30" cy="370" r="4" fill="#b8860b" opacity="0.5"/>
                    <circle cx="30" cy="370" r="1.5" fill="#0d4028" opacity="0.8"/>
                    <circle cx="270" cy="375" r="4" fill="#b8860b" opacity="0.5"/>
                    <circle cx="270" cy="375" r="1.5" fill="#0d4028" opacity="0.8"/>
                    {/* Horizontal runs */}
                    <path d="M0,120 H20 L35,135" stroke="#b8860b" stroke-width="1.5" fill="none" opacity="0.25"/>
                    <path d="M300,180 H275 L260,165" stroke="#b8860b" stroke-width="1.5" fill="none" opacity="0.25"/>
                    <path d="M0,280 H25 L40,265" stroke="#b8860b" stroke-width="1.5" fill="none" opacity="0.25"/>
                    <path d="M300,320 H280 L265,335" stroke="#b8860b" stroke-width="1.5" fill="none" opacity="0.25"/>
                  </svg>
                  {/* Mounting holes */}
                  <div class="box-card__pcb-hole box-card__pcb-hole--tl"></div>
                  <div class="box-card__pcb-hole box-card__pcb-hole--tr"></div>
                  <div class="box-card__pcb-hole box-card__pcb-hole--bl"></div>
                  <div class="box-card__pcb-hole box-card__pcb-hole--br"></div>
                  <div class="box-card__pcb-header">
                    <a href={internalHref(`roadmaps/${slug}`)} class="box-card__pcb-chip">
                      <span class="box-card__pcb-chip-notch"></span>
                      <span class="box-card__pcb-chip-label">{meta.title}</span>
                    </a>
                  </div>
                  <p class="box-card__pcb-desc">{meta.description}</p>
                  <div class="box-card__pcb-sections">
                    {sections.map((section) => (
                      <div class="box-card__pcb-section">
                        <a href={internalHref(`roadmaps/${slug}#${section.id}`)} class="box-card__pcb-section-header">
                          <span class="box-card__pcb-led"></span>
                          <span class="box-card__pcb-section-title">{section.title}</span>
                        </a>
                        <ul class="box-card__pcb-topics">
                          {section.items.map((item) => (
                            <li>
                              <a href={internalHref(`roadmaps/${slug}#${item.id}`)} class="box-card__pcb-topic">
                                {item.title}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </article>
          );
        })}
      </div>

      <!-- Custom Tracks Section (injected client-side) -->
      <div id="custom-tracks-section" class="custom-tracks-section" hidden>
        <h2 class="custom-tracks-heading">My Custom Tracks</h2>
        <div id="custom-tracks-grid" class="tracks-grid"></div>
      </div>

      {/* Mobile hint popup */}
      <div class="tap-hint" id="tap-hint">
        Tap again to open
      </div>
    </div>

    {/* PCB Modal */}
    <div class="pcb-modal-backdrop" id="modal-backdrop">
      <div class="pcb-modal" id="modal">
        {/* Solder mask green background with traces */}
        <div class="pcb-modal__board">
          {/* Mounting holes */}
          <div class="pcb-hole pcb-hole--tl"></div>
          <div class="pcb-hole pcb-hole--tr"></div>
          <div class="pcb-hole pcb-hole--bl"></div>
          <div class="pcb-hole pcb-hole--br"></div>
          
          {/* Decorative traces */}
          <svg class="pcb-modal__traces" id="modal-traces" viewBox="0 0 600 400">
            <!-- Populated by JS -->
          </svg>
          
          {/* Silkscreen content */}
          <div class="pcb-modal__silkscreen">
            <button class="pcb-modal__close" id="modal-close" aria-label="Close">×</button>
            
            <div class="pcb-modal__header">
              <a href="#" class="pcb-modal__chip" id="modal-chip-link">
                <span class="pcb-modal__chip-notch"></span>
                <span class="pcb-modal__chip-label" id="modal-title">Track Name</span>
                <span class="pcb-modal__chip-glow"></span>
              </a>
            </div>
            
            <p class="pcb-modal__desc" id="modal-desc"></p>
            
            <a class="pcb-modal__cta" id="modal-link" href="#">
              <span class="pcb-modal__cta-pad"></span>
              Open Roadmap →
              <span class="pcb-modal__cta-pad"></span>
            </a>
            
            <div class="pcb-modal__sections" id="modal-sections">
              <!-- Populated by JS -->
            </div>
            
            {/* Reference designator */}
            <div class="pcb-modal__refdes">
              <span>REV {VERSION}</span>
              <span>EEE-ROADMAP</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script define:vars={{ tracksData }}>
  window.tracksData = tracksData;
</script>

<script>
  interface TrackData {
    slug: string;
    title: string;
    description: string;
    href: string;
    sections: { id: string; title: string; topics: { id: string; title: string }[] }[];
  }
  
  const tracksData = (window as any).tracksData as TrackData[];
  
  const backdrop = document.getElementById('modal-backdrop')!;
  const modal = document.getElementById('modal')!;
  const modalClose = document.getElementById('modal-close')!;
  const modalTitle = document.getElementById('modal-title')!;
  const modalDesc = document.getElementById('modal-desc')!;
  const modalLink = document.getElementById('modal-link') as HTMLAnchorElement;
  const modalSections = document.getElementById('modal-sections')!;
  const tracesSvg = document.getElementById('modal-traces')!;

  // View toggle
  const viewBoxedBtn = document.getElementById('view-boxed');
  const viewUnboxedBtn = document.getElementById('view-unboxed');
  const viewHint = document.getElementById('view-hint');
  const tracksGrid = document.querySelector('.tracks-grid');

  let currentView = 'boxed';

  viewBoxedBtn?.addEventListener('click', () => {
    if (currentView === 'boxed') return;
    currentView = 'boxed';
    viewBoxedBtn.classList.add('view-toggle-btn--active');
    viewUnboxedBtn?.classList.remove('view-toggle-btn--active');
    tracksGrid?.classList.remove('tracks-grid--unboxed');
    if (viewHint) viewHint.textContent = 'Unbox box by clicking to preview contents';
  });

  viewUnboxedBtn?.addEventListener('click', () => {
    if (currentView === 'unboxed') return;
    currentView = 'unboxed';
    viewUnboxedBtn.classList.add('view-toggle-btn--active');
    viewBoxedBtn?.classList.remove('view-toggle-btn--active');
    tracksGrid?.classList.add('tracks-grid--unboxed');
    if (viewHint) viewHint.textContent = 'Unboxed PCB cards with all sections and topics';
  });

  // Hide box elements completely after animation
  tracksGrid?.addEventListener('transitionend', (e) => {
    if (e.target === tracksGrid) return;
    
    if (currentView === 'unboxed') {
      tracksGrid.querySelectorAll('.box-card__base, .box-card__lid, .box-card__tape').forEach(el => {
        (el as HTMLElement).style.display = 'none';
      });
    }
  });

  // Restore before animation starts
  viewBoxedBtn?.addEventListener('click', () => {
    tracksGrid?.querySelectorAll('.box-card__base, .box-card__lid, .box-card__tape').forEach(el => {
      (el as HTMLElement).style.display = '';
    });
  });

  let activeCard: HTMLElement | null = null;

  // Draw traces connecting elements after DOM is updated
  function drawTraces() {
    const board = document.querySelector('.pcb-modal__board') as HTMLElement;
    if (!board) return;
    
    const boardRect = board.getBoundingClientRect();
    const width = Math.round(boardRect.width);
    const height = Math.round(boardRect.height);
    
    tracesSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
    
    const COPPER = '#b8860b';
    const paths: string[] = [];
    const vias: string[] = [];
    
    // Helper: create path with 45° routing
    const trace = (d: string, opacity = 0.5, strokeWidth = 2.5) => 
      `<path d="${d}" stroke="${COPPER}" stroke-width="${strokeWidth}" fill="none" opacity="${opacity}" stroke-linecap="round" stroke-linejoin="round" />`;
    
    const via = (x: number, y: number, r = 5, opacity = 0.6) =>
      `<circle cx="${x}" cy="${y}" r="${r}" fill="${COPPER}" opacity="${opacity}" /><circle cx="${x}" cy="${y}" r="${r * 0.4}" fill="#0d4028" opacity="0.8" />`;

    // === TOP LEFT CORNER ===
    paths.push(trace(`M0,30 H15 L30,45 V70`, 0.5));
    paths.push(trace(`M0,50 H10 L25,65`, 0.4, 2));
    paths.push(trace(`M20,0 V15 L35,30 H55`, 0.5));
    paths.push(trace(`M40,0 V10 L50,20`, 0.4, 2));
    vias.push(via(30, 45));
    vias.push(via(35, 30));
    
    // === TOP RIGHT CORNER ===
    paths.push(trace(`M${width},35 H${width-20} L${width-40},55 V75`, 0.5));
    paths.push(trace(`M${width},55 H${width-15} L${width-30},70`, 0.4, 2));
    paths.push(trace(`M${width-25},0 V20 L${width-45},40`, 0.5));
    paths.push(trace(`M${width-50},0 V15 L${width-65},30 H${width-85}`, 0.4, 2));
    vias.push(via(width - 40, 55));
    vias.push(via(width - 45, 40));
    
    // === BOTTOM LEFT CORNER ===
    paths.push(trace(`M0,${height-40} H20 L40,${height-60} V${height-80}`, 0.5));
    paths.push(trace(`M0,${height-70} H15 L30,${height-85}`, 0.4, 2));
    paths.push(trace(`M25,${height} V${height-20} L45,${height-40}`, 0.5));
    vias.push(via(40, height - 60));
    vias.push(via(25, height - 20));
    
    // === BOTTOM RIGHT CORNER ===
    paths.push(trace(`M${width},${height-45} H${width-25} L${width-50},${height-70}`, 0.5));
    paths.push(trace(`M${width-30},${height} V${height-25} L${width-55},${height-50} H${width-80}`, 0.5));
    paths.push(trace(`M${width},${height-80} H${width-20} L${width-35},${height-95}`, 0.4, 2));
    vias.push(via(width - 50, height - 70));
    vias.push(via(width - 55, height - 50));
    
    // === LEFT EDGE - busy traces ===
    for (let i = 0; i < 6; i++) {
      const y = 100 + i * 50;
      if (y < height - 100) {
        const len = 25 + (i * 13) % 35;
        const drop = 15 + (i * 7) % 25;
        paths.push(trace(`M0,${y} H${len} L${len + drop},${y + drop}`, 0.35 + (i % 2) * 0.15, 2));
        if (i % 2 === 0) vias.push(via(len + drop, y + drop, 4, 0.5));
      }
    }
    
    // === RIGHT EDGE - busy traces ===
    for (let i = 0; i < 6; i++) {
      const y = 120 + i * 50;
      if (y < height - 100) {
        const len = 30 + (i * 11) % 40;
        const drop = 20 + (i * 9) % 20;
        const dir = i % 2 === 0 ? 1 : -1;
        paths.push(trace(`M${width},${y} H${width - len} L${width - len - drop},${y + drop * dir}`, 0.35 + (i % 2) * 0.15, 2));
        if (i % 3 === 0) vias.push(via(width - len - drop, y + drop * dir, 4, 0.5));
      }
    }
    
    // === HORIZONTAL RUNS with 45° jogs ===
    paths.push(trace(`M0,${height * 0.3} H40 L55,${height * 0.3 + 15} H90`, 0.3, 1.5));
    paths.push(trace(`M${width},${height * 0.4} H${width - 50} L${width - 70},${height * 0.4 - 20} H${width - 100}`, 0.3, 1.5));
    paths.push(trace(`M0,${height * 0.6} H30 L50,${height * 0.6 - 20}`, 0.3, 1.5));
    paths.push(trace(`M${width},${height * 0.7} H${width - 35} L${width - 55},${height * 0.7 + 20}`, 0.3, 1.5));
    
    // === DIAGONAL CROSS TRACES (background interest) ===
    paths.push(trace(`M60,${height - 30} L90,${height - 60} V${height - 90}`, 0.25, 1.5));
    paths.push(trace(`M${width - 70},${height - 25} L${width - 100},${height - 55}`, 0.25, 1.5));
    
    // === POWER/GROUND RAILS (thicker, top and bottom) ===
    paths.push(trace(`M50,15 H${width - 50}`, 0.2, 4));
    paths.push(trace(`M50,${height - 15} H${width - 50}`, 0.2, 4));
    
    tracesSvg.innerHTML = paths.join('\n') + '\n' + vias.join('\n');
  }

  function openModal(slug: string, cardEl: HTMLElement) {
    const data = tracksData.find(t => t.slug === slug);
    if (!data) return;

    activeCard = cardEl;
    
    modalTitle.textContent = data.title.toUpperCase();
    modalDesc.textContent = data.description;
    modalLink.href = data.href;

    const modalChipLink = document.getElementById('modal-chip-link') as HTMLAnchorElement;
    if (modalChipLink) modalChipLink.href = data.href;
    
    // Build sections HTML
    modalSections.innerHTML = data.sections.map((section, sectionIndex) => `
      <div class="pcb-section" data-section-index="${sectionIndex}">
        <a href="${data.href}#${section.id}" class="pcb-section__header">
          <span class="pcb-section__led"></span>
          <span class="pcb-section__title">${section.title}</span>
        </a>
        <ul class="pcb-section__topics">
          ${section.topics.map((topic) => `
            <li class="pcb-topic">
              <a href="${data.href}#${topic.id}" class="pcb-topic__link">
                <span class="pcb-topic__pad"></span>
                <span class="pcb-topic__name">${topic.title}</span>
              </a>
            </li>
          `).join('')}
        </ul>
      </div>
    `).join('');

    const rect = cardEl.getBoundingClientRect();
    modal.style.setProperty('--origin-x', `${rect.left + rect.width / 2}px`);
    modal.style.setProperty('--origin-y', `${rect.top + rect.height / 2}px`);
    
    backdrop.classList.add('is-open');
    cardEl.classList.add('is-selected');
    document.body.style.overflow = 'hidden';
    
    // Draw traces after modal is visible and laid out
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        drawTraces();
      });
    });
  }

  function closeModal() {
    backdrop.classList.remove('is-open');
    if (activeCard) {
      activeCard.classList.remove('is-selected');
      activeCard = null;
    }
    document.body.style.overflow = '';
  }

  // Card click handlers
  const tapHint = document.getElementById('tap-hint');
  let hintTimeout: ReturnType<typeof setTimeout> | null = null;

  document.querySelectorAll('.box-card').forEach(card => {
    let isOpened = false;
    
    card.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('a')) return;

      // Don't open modal in unboxed view
      if (currentView === 'unboxed') return;
      
      const isMobile = window.matchMedia('(hover: none)').matches;
      
      if (isMobile && !isOpened) {
        document.querySelectorAll('.box-card').forEach(c => {
          c.classList.remove('is-opened');
        });
        card.classList.add('is-opened');
        isOpened = true;
        
        if (hintTimeout) clearTimeout(hintTimeout);
        hintTimeout = setTimeout(() => {
          if (card.classList.contains('is-opened')) {
            tapHint?.classList.add('is-visible');
            setTimeout(() => {
              tapHint?.classList.remove('is-visible');
            }, 2000);
          }
        }, 1000);
        
        return;
      }
      
      if (hintTimeout) clearTimeout(hintTimeout);
      tapHint?.classList.remove('is-visible');
      
      const slug = card.getAttribute('data-track');
      if (slug) openModal(slug, card as HTMLElement);
    });
  });

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!target.closest('.box-card')) {
      document.querySelectorAll('.box-card').forEach(c => {
        c.classList.remove('is-opened');
      });
      tapHint?.classList.remove('is-visible');
      if (hintTimeout) clearTimeout(hintTimeout);
    }
  });

  modalClose.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
  
  // Redraw traces on resize
  window.addEventListener('resize', () => {
    if (backdrop.classList.contains('is-open')) {
      drawTraces();
    }
  });

  // Category filtering
  const filterBar = document.getElementById('filter-bar');
  const filterBtns = filterBar?.querySelectorAll('.filter-label');
  const cards = document.querySelectorAll('.box-card');

  filterBtns?.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active button
      filterBtns.forEach(b => b.classList.remove('filter-label--active'));
      btn.classList.add('filter-label--active');
      
      applyFilters();
    });
  });

  // Progress filtering
  const STORAGE_KEY = 'eee-progress-v2';

  function getProgress(): { complete: string[]; important: string[] } {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : { complete: [], important: [] };
    } catch {
      return { complete: [], important: [] };
    }
  }

  let activeProgressFilter = 'all';
  const progressFilter = document.getElementById('progress-filter');
  const progressBtns = progressFilter?.querySelectorAll('.progress-btn');

  function applyFilters() {
    const progress = getProgress();
    
    cards.forEach(card => {
      const category = card.getAttribute('data-category');
      const keysAttr = card.getAttribute('data-concept-keys');
      const conceptKeys: string[] = keysAttr ? JSON.parse(keysAttr) : [];
      
      // Category filter
      const activeCategory = document.querySelector('.filter-label--active')?.getAttribute('data-category') || 'all';
      const passesCategory = activeCategory === 'all' || category === activeCategory;
      
      // Progress filter
      let passesProgress = true;
      if (activeProgressFilter === 'incomplete') {
        // Has at least one concept NOT in complete
        passesProgress = conceptKeys.some(key => !progress.complete.includes(key));
      } else if (activeProgressFilter === 'highlighted') {
        // Has at least one concept in important
        passesProgress = conceptKeys.some(key => progress.important.includes(key));
      }
      
      // Both must pass
      if (passesCategory && passesProgress) {
        card.classList.remove('is-hidden');
      } else {
        card.classList.add('is-hidden');
      }
    });
  }

  progressBtns?.forEach(btn => {
    btn.addEventListener('click', () => {
      activeProgressFilter = btn.getAttribute('data-progress') || 'all';
      
      // Update active button
      progressBtns.forEach(b => b.classList.remove('progress-btn--active'));
      btn.classList.add('progress-btn--active');
      
      applyFilters();
    });
  });

  // ============================================
  // CUSTOM TRACKS (from Supabase)
  // ============================================
  async function initCustomTracks() {
    const { injectCustomTracks } = await import('../../utils/customContent');
    await injectCustomTracks();
  }

  initCustomTracks();
</script>

<style is:global>
  /* ==================== PAGE ==================== */
  .tracks-page {
    min-height: 100vh;
  }

  .tracks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
  }

  /* ==================== BOX CARD ==================== */
  .box-card {
    --box-color: #d4a574;
    --box-dark: #b8956a;
    --box-light: #e6c9a8;
    --tape-color: #c9a86c;
    
    position: relative;
    cursor: pointer;
    perspective: 800px;
  }

  .box-card__base {
    position: relative;
    background: linear-gradient(145deg, var(--box-light) 0%, var(--box-color) 50%, var(--box-dark) 100%);
    border: 2px solid var(--box-dark);
    padding: 1.5rem;
    padding-top: 2rem;
    min-height: 200px;
    transition: box-shadow 0.3s ease;
  }

  /* Inner shadow to show box depth */
  .box-card__base::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: linear-gradient(180deg, rgba(0,0,0,0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 0;
  }

  .box-card:hover .box-card__base::before,
  .box-card.is-opened .box-card__base::before {
    opacity: 1;
  }

  .box-card:hover .box-card__base,
  .box-card.is-opened .box-card__base {
    box-shadow: 
      inset 0 15px 30px -10px rgba(0, 0, 0, 0.25),
      inset 2px 0 8px -4px rgba(0, 0, 0, 0.15),
    inset -2px 0 8px -4px rgba(0, 0, 0, 0.15),
    0 8px 25px rgba(0, 0, 0, 0.2);
}
  .box-card:hover .box-card__base {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  }

  /* Lid */
  .box-card__lid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    z-index: 10;
    transform-style: preserve-3d;
    transform-origin: top center;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .box-card:hover .box-card__lid {
    transform: rotateX(-95deg);
  }

  .box-card__lid-front {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(180deg, var(--box-light) 0%, var(--box-color) 100%);
    border: 2px solid var(--box-dark);
    border-bottom: none;
    display: flex;
    align-items: center;
    justify-content: center;
    backface-visibility: hidden;
  }

  .box-card__lid-top {
    position: absolute;
    bottom: 100%;
    left: -2px;
    right: -2px;
    height: 20px;
    background: var(--box-color);
    border: 2px solid var(--box-dark);
    border-bottom: none;
    transform-origin: bottom center;
    transform: rotateX(90deg);
  }

  /* Label on lid */
  .box-card__label {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.5625rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.125rem 0.5rem;
    border: 1px dashed;
  }

  .box-card__label--unverified {
    color: #b45309;
    background: #fef3c7;
    border-color: #b45309;
  }

  .box-card__label--verified {
    color: #047857;
    background: #d1fae5;
    border-color: #047857;
  }

  /* Box base shadow on hover/open */
  .box-card:hover .box-card__base,
  .box-card.is-opened .box-card__base {
    box-shadow: 
      inset 0 20px 30px -15px rgba(0, 0, 0, 0.3),
      0 8px 30px rgba(0, 0, 0, 0.2);
  }

  /* Lid gets depth when open */
  .box-card:hover .box-card__lid-front,
  .box-card.is-opened .box-card__lid-front {
    box-shadow: 
      0 10px 25px rgba(0, 0, 0, 0.4),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Lid top face */
  .box-card__lid-top {
    position: absolute;
    bottom: 100%;
    left: -2px;
    right: -2px;
    height: 25px;
    background: linear-gradient(180deg, var(--box-dark) 0%, var(--box-color) 100%);
    border: 2px solid var(--box-dark);
    border-bottom: none;
    transform-origin: bottom center;
    transform: rotateX(90deg);
  }

  /* Inner shadow to show depth of box */
  .box-card__base::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(180deg, rgba(0,0,0,0.15) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }

  .box-card:hover .box-card__base::after,
  .box-card.is-opened .box-card__base::after {
    opacity: 1;
  }

  /* PCB peek styling */
  .box-card__pcb-preview {
    position: absolute;
    top: 8px;
    left: 8%;
    right: 8%;
    height: 35px;
    overflow: hidden;
    opacity: 0;
    transform: translateY(15px);
    transition: opacity 0.3s ease 0.15s, transform 0.3s ease 0.15s;
    z-index: 2;
  }

  .box-card:hover .box-card__pcb-preview {
    opacity: 1;
    transform: translateY(0);
  }

  .pcb-peek {
    height: 70px;
    background: #1a5c38;
    border: 2px solid #0d4028;
    border-radius: 2px;
    box-shadow: 
      inset 0 -10px 20px rgba(0, 0, 0, 0.3),
      0 4px 8px rgba(0, 0, 0, 0.2);
    position: relative;
  }

  .pcb-peek__traces {
    position: absolute;
    inset: 0;
    background: 
      linear-gradient(90deg, transparent 8px, #b8860b 8px, #b8860b 9px, transparent 9px),
      linear-gradient(0deg, transparent 8px, #b8860b 8px, #b8860b 9px, transparent 9px);
    background-size: 12px 12px;
    opacity: 0.25;
  }

  /* Tape */
  .box-card__tape {
    position: absolute;
    background: var(--tape-color);
    opacity: 0.6;
    z-index: 5; /* Below lid (10) */
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .box-card__tape--h {
    top: 38px; /* Move below lid */
    left: 15%;
    right: 15%;
    height: 18px;
    background: linear-gradient(
      180deg,
      transparent 0%,
      var(--tape-color) 15%,
      var(--tape-color) 85%,
      transparent 100%
    );
  }

  .box-card__tape--v {
    display: none; /* Remove vertical tape, too cluttered */
  }

  .box-card:hover .box-card__tape {
    opacity: 0.2;
  }

  /* PCB Preview (peeking out) */
  .box-card__pcb-preview {
    position: absolute;
    top: 0;
    left: 10%;
    right: 10%;
    height: 30px;
    overflow: hidden;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s;
  }

  .box-card:hover .box-card__pcb-preview {
    opacity: 1;
    transform: translateY(0);
  }

  .pcb-peek {
    height: 60px;
    background: #1a5c38;
    border: 2px solid #0d4028;
    border-radius: 2px;
  }

  .pcb-peek__traces {
    height: 100%;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 8px,
      #b8860b 8px,
      #b8860b 9px
    );
    opacity: 0.3;
  }

  /* Box content */
  .box-card__content {
    position: relative;
    z-index: 1;
  }

  .box-card__header {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    margin-bottom: 0.5rem;
  }

  .box-card__icon {
    width: 1.25rem;
    height: 1.25rem;
    color: #5d4e37;
    flex-shrink: 0;
  }

  .box-card__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 1rem;
    font-weight: 700;
    color: #3d2e1f;
  }

  .box-card__desc {
    font-size: 0.8125rem;
    color: #5d4e37;
    line-height: 1.5;
    margin-bottom: 0.75rem;
  }

  .box-card__meta {
    display: inline-flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    background: rgba(0, 0, 0, 0.05);
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
  }

  .box-card__stat {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.6875rem;
    color: #5d4e37;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(255, 255, 255, 0.4);
    padding: 0.125rem 0.375rem;
    border-radius: 2px;
  }

  .box-card__sections {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding-top: 0.75rem;
    border-top: 1px dashed #b8956a;
  }

  .box-card__section {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.5625rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #5d4e37;
    padding: 0.1875rem 0.375rem;
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid #b8956a;
  }

  /* Mobile tap-to-open state */
  .box-card.is-opened .box-card__lid {
    transform: rotateX(-95deg);
  }

  .box-card.is-opened .box-card__base {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  }

  .box-card.is-opened .box-card__pcb-preview {
    opacity: 1;
    transform: translateY(0);
  }

  .box-card.is-opened .box-card__tape {
    opacity: 0.2;
  }

  .box-card.is-opened .box-card__lid-front {
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
  }

  /* ==================== PCB MODAL ==================== */
  .pcb-modal-backdrop {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: rgba(0, 0, 0, 0);
    visibility: hidden;
    transition: background 0.3s ease, visibility 0.3s;
  }

  .pcb-modal-backdrop.is-open {
    background: rgba(0, 0, 0, 0.7);
    visibility: visible;
  }

  .pcb-modal {
    --origin-x: 50%;
    --origin-y: 50%;
    
    width: 100%;
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
    transform: scale(0.7) rotateX(20deg);
    opacity: 0;
    transition: 
      transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
      opacity 0.3s ease;
  }

  .pcb-modal-backdrop.is-open .pcb-modal {
    transform: scale(1) rotateX(0deg);
    opacity: 1;
  }

  /* The actual PCB board */
  .pcb-modal__board {
    --pcb-green: #1a5c38;
    --pcb-green-light: #228b4a;
    --pcb-copper: #b8860b;
    --pcb-gold: #daa520;
    --pcb-silkscreen: #f5f5f0;
    
    position: relative;
    background: var(--pcb-green);
    border: 3px solid #0d4028;
    border-radius: 4px;
    padding: 1.5rem;
    box-shadow: 
      0 4px 8px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Mounting holes */
  .pcb-hole {
    position: absolute;
    width: 14px;
    height: 14px;
    border: 3px solid var(--pcb-copper);
    border-radius: 50%;
    background: #111;
  }

  .pcb-hole::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 6px;
    height: 6px;
    background: #333;
    border-radius: 50%;
  }

  .pcb-hole--tl { top: 8px; left: 8px; }
  .pcb-hole--tr { top: 8px; right: 8px; }
  .pcb-hole--bl { bottom: 8px; left: 8px; }
  .pcb-hole--br { bottom: 8px; right: 8px; }

  /* Traces SVG */
  .pcb-modal__traces {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0; /* Behind silkscreen content */
  }

  .pcb-modal__traces path {
    fill: none;
  }

  .pcb-modal__traces circle {
    /* styles applied inline */
  }

  /* Silkscreen layer */
  .pcb-modal__silkscreen {
    position: relative;
    z-index: 1;
    color: var(--pcb-silkscreen);
  }

  .pcb-modal__close {
    position: absolute;
    top: 0;
    right: 0;
    width: 32px;
    height: 32px;
    background: var(--pcb-copper);
    border: none;
    color: #111;
    font-size: 1.25rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }

  .pcb-modal__close:hover {
    background: var(--pcb-gold);
  }

  /* Chip header */
  .pcb-modal__header {
    margin-bottom: 1rem;
    padding-right: 2.5rem;
  }

  /* Chip as clickable link */
  .pcb-modal__chip {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    background: #111;
    padding: 0.5rem 1rem;
    border: 2px solid #333;
    position: relative;
    text-decoration: none;
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.3s, transform 0.2s;
  }

  .pcb-modal__chip:hover {
    border-color: #b8860b;
    transform: translateY(-2px);
  }

  /* Electric flow glow element */
  .pcb-modal__chip-glow {
    position: absolute;
    inset: 0;
    opacity: 0;
    transform: translateX(-100%);
    transition: opacity 0.2s;
    pointer-events: none;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0) 35%,
      rgba(255, 255, 255, 0.3) 50%,
      rgba(255, 255, 255, 0) 65%,
      transparent 100%
    );
  }

  .pcb-modal__chip:hover .pcb-modal__chip-glow {
    opacity: 1;
    animation: electric-flow 0.8s ease-in-out infinite, glow-rgb 2s linear infinite;
  }

  @keyframes electric-flow {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  .pcb-modal__chip:hover .pcb-modal__chip-notch {
    border-color: transparent;
    animation: rgb-led 2s linear infinite;
  }

  @keyframes rgb-led {
    0% {
      background: #ff0000;
      box-shadow: 0 0 8px #ff0000, 0 0 16px #ff0000;
    }
    16% {
      background: #ff8800;
      box-shadow: 0 0 8px #ff8800, 0 0 16px #ff8800;
    }
    33% {
      background: #ffff00;
      box-shadow: 0 0 8px #ffff00, 0 0 16px #ffff00;
    }
    50% {
      background: #00ff00;
      box-shadow: 0 0 8px #00ff00, 0 0 16px #00ff00;
    }
    66% {
      background: #00ffff;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #00ffff;
    }
    83% {
      background: #8800ff;
      box-shadow: 0 0 8px #8800ff, 0 0 16px #8800ff;
    }
    100% {
      background: #ff0000;
      box-shadow: 0 0 8px #ff0000, 0 0 16px #ff0000;
    }
  }

  /* LED in chip pulses on hover */
  .pcb-modal__chip-notch {
    width: 8px;
    height: 8px;
    border: 2px solid #444;
    border-radius: 50%;
    background: #222;
    transition: all 0.3s;
  }

  .pcb-modal__chip-label {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: #f5f5f0;
    position: relative;
    z-index: 1;
  }

  .pcb-modal__chip::before,
  .pcb-modal__chip::after {
    content: '';
    position: absolute;
    left: -6px;
    width: 4px;
    height: 8px;
    background: var(--pcb-copper);
  }

  .pcb-modal__chip::before { top: 25%; }
  .pcb-modal__chip::after { bottom: 25%; }

  .pcb-modal__chip-label {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.1em;
  }

  .pcb-modal__desc {
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
    opacity: 0.9;
  }

  /* CTA button as a component */
  .pcb-modal__cta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--pcb-copper);
    color: #111;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: background 0.2s, transform 0.2s;
  }

  .pcb-modal__cta:hover {
    background: var(--pcb-gold);
    transform: translateY(-2px);
  }

  .pcb-modal__cta-pad {
    width: 6px;
    height: 6px;
    background: #111;
    border-radius: 1px;
  }

  /* ==================== PCB SECTIONS (IC + SMD Layout) ==================== */
  .pcb-modal__sections {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: relative;
    z-index: 2;
  }

  /* Container for each section group */
  .pcb-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .pcb-section__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #e0e0e0;
  }

  /* LED indicator */
  .pcb-section__led {
    width: 8px;
    height: 8px;
    background: #333;
    border-radius: 50%;
    border: 1px solid #444;
    flex-shrink: 0;
    transition: all 0.2s ease;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
  }

  /* Section header as link */
  .pcb-section__header {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.875rem;
    background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
    border: 2px solid #333;
    border-radius: 2px;
    width: fit-content;
    position: relative;
    box-shadow: 
      0 3px 8px rgba(0, 0, 0, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    text-decoration: none;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.15s;
  }

  .pcb-section__header:hover {
    border-color: #555;
    transform: translateY(-1px);
  }

  /* LED colors on hover - randomized via nth-child */
  .pcb-section:nth-child(5n+1) .pcb-section__header:hover .pcb-section__led {
    background: #ff4444;
    box-shadow: 0 0 8px #ff4444, 0 0 12px #ff4444, inset 0 0 4px rgba(255,255,255,0.3);
  }

  .pcb-section:nth-child(5n+2) .pcb-section__header:hover .pcb-section__led {
    background: #44ff44;
    box-shadow: 0 0 8px #44ff44, 0 0 12px #44ff44, inset 0 0 4px rgba(255,255,255,0.3);
  }

  .pcb-section:nth-child(5n+3) .pcb-section__header:hover .pcb-section__led {
    background: #ffaa00;
    box-shadow: 0 0 8px #ffaa00, 0 0 12px #ffaa00, inset 0 0 4px rgba(255,255,255,0.3);
  }

  .pcb-section:nth-child(5n+4) .pcb-section__header:hover .pcb-section__led {
    background: #44aaff;
    box-shadow: 0 0 8px #44aaff, 0 0 12px #44aaff, inset 0 0 4px rgba(255,255,255,0.3);
  }

  .pcb-section:nth-child(5n+5) .pcb-section__header:hover .pcb-section__led {
    background: #ff44ff;
    box-shadow: 0 0 8px #ff44ff, 0 0 12px #ff44ff, inset 0 0 4px rgba(255,255,255,0.3);
  }

  /* IC pins on left - keep this */
  .pcb-section__header::after {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 60%;
    background: repeating-linear-gradient(
      180deg,
      transparent 0px,
      transparent 3px,
      #b8860b 3px,
      #b8860b 6px,
      transparent 6px,
      transparent 9px
    );
  }

  /* Topic as clickable link */
  .pcb-topic {
    display: inline-flex;
    padding: 0;
    background: none;
    border: none;
    box-shadow: none;
  }

  .pcb-topic__link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.5rem;
    background: linear-gradient(180deg, #1f1f1f 0%, #141414 100%);
    border: 1px solid #2a2a2a;
    border-radius: 2px;
    font-size: 0.6875rem;
    text-decoration: none;
    transition: all 0.15s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .pcb-topic__link:hover {
    background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
    border-color: #b8860b;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
  }

  .pcb-topic__link::after {
    content: '';
    width: 4px;
    height: 12px;
    background: linear-gradient(180deg, #d4a84b 0%, #b8860b 50%, #8a6508 100%);
    border-radius: 1px;
  }

  /* SMD pads on sides */
  .pcb-topic__pad {
    width: 4px;
    height: 10px;
    background: linear-gradient(180deg, #d4a84b 0%, #b8860b 50%, #8a6508 100%);
    border-radius: 1px;
    flex-shrink: 0;
    box-shadow: 0 0 2px rgba(184, 134, 11, 0.5);
  }

  .pcb-topic__name {
    color: rgba(245, 245, 240, 0.85);
    white-space: nowrap;
  }

  /* Section divider line */
  .pcb-section:not(:last-child)::after {
    content: '';
    display: block;
    margin-top: 0.75rem;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(184, 134, 11, 0.3) 10%,
      rgba(184, 134, 11, 0.3) 90%,
      transparent 100%
    );
  }

  /* Reference designator */
  .pcb-modal__refdes {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.5625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.6;
    color: var(--pcb-silkscreen);
  }

  /* ==================== DARK MODE BOX CARDS ==================== */
  :root.dark .box-card,
  .dark .box-card {
    --box-color: #5a4d42;
    --box-dark: #3d342c;
    --box-light: #7a6b5a;
    --tape-color: #6a5840;
  }

  :root.dark .box-card__title,
  .dark .box-card__title { 
    color: #f5f0e8; 
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  :root.dark .box-card__desc,
  .dark .box-card__desc { 
    color: #e8e0d4; 
  }

  :root.dark .box-card__icon,
  .dark .box-card__icon { 
    color: #d4c8b8; 
  }

  :root.dark .box-card__stat,
  .dark .box-card__stat {
    color: #d4c8b8;
    background: rgba(0, 0, 0, 0.2);
    padding: 0.125rem 0.375rem;
    border-radius: 2px;
  }

  :root.dark .box-card__section,
  .dark .box-card__section {
    color: #e0d8cc;
    background: rgba(0, 0, 0, 0.3);
    border-color: #4a3a2a;
  }

  :root.dark .box-card__label--unverified,
  .dark .box-card__label--unverified {
    background: #3a2810;
    color: #f0c060;
    border-color: #5a4020;
  }

  /* ==================== RESPONSIVE ==================== */
  @media (max-width: 640px) {
    .tracks-grid {
      gap: 1.5rem;
    }

    .pcb-modal {
      max-height: 90vh;
    }

    .pcb-modal__board {
      padding: 1rem;
    }
  }

  .instruction-mobile {
    display: none;
  }

  @media (hover: none) {
    .instruction-desktop {
      display: none;
    }
    .instruction-mobile {
      display: inline;
    }
  }

  .tap-hint {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--color-copper);
    color: white;
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
    z-index: 1000;
    pointer-events: none;
  }

  .tap-hint.is-visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  /* Filter bar - Shipping labels */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
  }

  .filter-label {
    position: relative;
    padding: 0.5rem 1rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: #f5f0e6;
    border: 1px dashed #c9b896;
    color: #5d4e37;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 1px 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Torn edge effect */
  .filter-label::before {
    content: '';
    position: absolute;
    top: -2px;
    left: 10%;
    right: 10%;
    height: 3px;
    background: linear-gradient(90deg, 
      transparent 0%, transparent 20%,
      #f5f0e6 20%, #f5f0e6 40%,
      transparent 40%, transparent 60%,
      #f5f0e6 60%, #f5f0e6 80%,
      transparent 80%, transparent 100%
    );
  }

  /* Via dots */
  .filter-label__via {
    position: absolute;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: #c9b896;
    border: 1px solid #a89876;
    transition: all 0.2s;
  }

  .filter-label__via::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 2px;
    height: 2px;
    background: #8a7a5a;
    border-radius: 50%;
  }

  .filter-label__via--tl { top: 4px; left: 4px; }
  .filter-label__via--br { bottom: 4px; right: 4px; }

  /* Stamp (hidden by default) */
  .filter-label__stamp {
    position: absolute;
    top: 50%;
    right: 6px;
    transform: translateY(-50%) rotate(-15deg) scale(0);
    color: #2a7d4f;
    opacity: 0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
  }

  .filter-label__text {
    position: relative;
    z-index: 1;
  }

  /* Hover */
  .filter-label:hover {
    background: #efe9db;
    border-color: #b8956a;
    transform: translateY(-1px);
    box-shadow: 2px 3px 6px rgba(0, 0, 0, 0.15);
  }

  /* Active state */
  .filter-label--active {
    background: #fffdf7;
    border: 1px solid var(--color-copper, #b8860b);
    box-shadow: 
      2px 3px 6px rgba(0, 0, 0, 0.12),
      inset 0 0 0 1px rgba(184, 134, 11, 0.2);
    padding-right: 1.75rem;
  }

  .filter-label--active .filter-label__stamp {
    transform: translateY(-50%) rotate(-15deg) scale(1);
    opacity: 1;
  }

  .filter-label--active .filter-label__via {
    background: var(--color-copper, #b8860b);
    border-color: #8a6a0b;
  }

  .filter-section {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .filter-section__label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #5d4e37;
    background: rgba(201, 184, 150, 0.3);
    padding: 0.375rem 0.625rem;
    border-left: 2px solid var(--color-copper, #b8860b);
  }

  :root.dark .filter-section__label,
  .dark .filter-section__label {
    color: #a89878;
    background: rgba(90, 74, 53, 0.3);
  }

  /* Dark mode */
  :root.dark .filter-label,
  .dark .filter-label {
    background: #3d3425;
    border-color: #5a4a35;
    color: #d4c8b8;
  }

  :root.dark .filter-label::before,
  .dark .filter-label::before {
    background: linear-gradient(90deg, 
      transparent 0%, transparent 20%,
      #3d3425 20%, #3d3425 40%,
      transparent 40%, transparent 60%,
      #3d3425 60%, #3d3425 80%,
      transparent 80%, transparent 100%
    );
  }

  :root.dark .filter-label__via,
  .dark .filter-label__via {
    background: #5a4a35;
    border-color: #4a3a25;
  }

  :root.dark .filter-label:hover,
  .dark .filter-label:hover {
    background: #4a3d2d;
    border-color: #6a5a45;
  }

  :root.dark .filter-label--active,
  .dark .filter-label--active {
    background: #4a3d2d;
    border-color: var(--color-copper, #b8860b);
  }

  .box-card.is-hidden {
    display: none;
  }

  :root.dark .filter-label__stamp,
  .dark .filter-label__stamp {
    color: #4ade80;
  }

  /* View toggle */
  .view-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .view-toggle-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 2px;
    color: var(--color-muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .view-toggle-btn:hover {
    border-color: var(--color-text);
    color: var(--color-text);
  }

  .view-toggle-btn--active {
    background: var(--color-copper, #b8860b);
    border-color: var(--color-copper, #b8860b);
    color: #111;
  }

  .view-controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .view-hint {
    font-size: 0.75rem;
    color: var(--color-muted);
    font-style: italic;
  }

  /* ==================== UNBOXED PCB VIEW ==================== */
  .box-card__pcb {
    display: none;
    position: absolute;
    inset: 0;
  }

  .box-card__pcb-board {
    position: relative;
    --pcb-green: #1a5c38;
    --pcb-copper: #b8860b;
    --pcb-silkscreen: #f5f5f0;
    
    background: var(--pcb-green);
    border: 3px solid #0d4028;
    border-radius: 4px;
    padding: 1rem;
    height: 100%;
    overflow: hidden;
    color: var(--pcb-silkscreen);
  }

  .box-card__pcb-header {
    margin-bottom: 0.75rem;
  }

  .box-card__pcb-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #111;
    padding: 0.375rem 0.75rem;
    border: 2px solid #333;
    text-decoration: none;
    color: var(--pcb-silkscreen);
    transition: border-color 0.2s;
  }

  .box-card__pcb-chip:hover {
    border-color: var(--pcb-copper);
  }

  .box-card__pcb-chip-notch {
    width: 6px;
    height: 6px;
    border: 2px solid #444;
    border-radius: 50%;
    background: #222;
  }

  .box-card__pcb-chip:hover .box-card__pcb-chip-notch {
    background: var(--pcb-copper);
    border-color: var(--pcb-copper);
  }

  .box-card__pcb-chip-label {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .box-card__pcb-desc {
    font-size: 0.75rem;
    line-height: 1.4;
    opacity: 0.85;
    margin-bottom: 0.75rem;
  }

  .box-card__pcb-sections {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .box-card__pcb-section-header {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.5rem;
    background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
    border: 1px solid #333;
    border-radius: 2px;
    text-decoration: none;
    color: var(--pcb-silkscreen);
    transition: border-color 0.2s;
  }

  .box-card__pcb-section-header:hover {
    border-color: #555;
  }

  .box-card__pcb-section-header:hover .box-card__pcb-led {
    background: #0f0;
    box-shadow: 0 0 6px #0f0;
  }

  .box-card__pcb-led {
    width: 6px;
    height: 6px;
    background: #333;
    border-radius: 50%;
    border: 1px solid #444;
    transition: all 0.2s;
  }

  .box-card__pcb-section-title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .box-card__pcb-topics {
    list-style: none;
    padding: 0;
    margin: 0.375rem 0 0 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .box-card__pcb-topic {
    font-size: 0.625rem;
    padding: 0.1875rem 0.375rem;
    background: rgba(184, 134, 11, 0.2);
    border: 1px solid var(--pcb-copper);
    border-radius: 1px;
    color: var(--pcb-silkscreen);
    text-decoration: none;
    transition: background 0.2s;
  }

  .box-card__pcb-topic:hover {
    background: var(--pcb-copper);
    color: #111;
  }

  /* ==================== UNBOXED GRID STATE ==================== */
  /* Transition setup for all cards */
  .box-card__lid {
    transition: transform 0.4s ease;
  }

  .box-card__base,
  .box-card__tape {
    transition: opacity 0.3s ease 0.2s;
  }

  .box-card__pcb {
    display: block;
    position: absolute;
    inset: 0;
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  /* Unboxed state */
  .tracks-grid--unboxed .box-card {
    height: auto;
  }

  .tracks-grid--unboxed .box-card__lid {
    transform: rotateX(-180deg);
    opacity: 0;
    transition: transform 0.4s ease, opacity 0.2s ease 0.3s;
  }

  .tracks-grid--unboxed .box-card__base,
  .tracks-grid--unboxed .box-card__tape {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .tracks-grid--unboxed .box-card__pcb {
    position: relative;
    height: auto;
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
    transition: opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;
  }

  .tracks-grid--unboxed .box-card__pcb-board {
    height: auto;
  }

  /* PCB traces */
  .box-card__pcb-traces {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  /* Mounting holes */
  .box-card__pcb-hole {
    position: absolute;
    width: 10px;
    height: 10px;
    border: 2px solid #b8860b;
    border-radius: 50%;
    background: #111;
    z-index: 1;
  }

  .box-card__pcb-hole::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 4px;
    height: 4px;
    background: #333;
    border-radius: 50%;
  }

  .box-card__pcb-hole--tl { top: 6px; left: 6px; }
  .box-card__pcb-hole--tr { top: 6px; right: 6px; }
  .box-card__pcb-hole--bl { bottom: 6px; left: 6px; }
  .box-card__pcb-hole--br { bottom: 6px; right: 6px; }

  /* ==================== CUSTOM TRACKS ==================== */
  .custom-tracks-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px dashed var(--color-border);
  }

  .custom-tracks-section[hidden] {
    display: none;
  }

  .custom-tracks-heading {
    font-family: "IBM Plex Mono", monospace;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .custom-tracks-heading::before {
    content: '✎';
    color: var(--color-copper);
  }

  .custom-badge {
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.2rem 0.5rem;
    background: var(--color-copper);
    color: white;
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 5;
  }

  .custom-track-card {
    position: relative;
    display: block;
    padding: 1.5rem;
    background: var(--color-bg);
    border: 2px dashed var(--color-copper);
    text-decoration: none;
    color: var(--color-text);
    transition: all 0.2s ease;
  }

  .custom-track-card:hover {
    border-style: solid;
    background: var(--color-bg-grid);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .custom-track-card__icon {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .custom-track-card__title {
    font-family: "IBM Plex Mono", monospace;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .custom-track-card__desc {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
    line-height: 1.4;
  }

  .custom-track-card__stats {
    font-family: "IBM Plex Mono", monospace;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
</style>