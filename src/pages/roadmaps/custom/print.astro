---
import PrintLayout from '../../../layouts/PrintLayout.astro';
---

<PrintLayout title="Custom Track - Print">
  <div class="print-page" id="print-page">
    <!-- Sidebar: checkbox tree (built client-side) -->
    <aside class="print-sidebar no-print" id="print-sidebar">
      <a href="#" class="print-back-link" id="back-link">&larr; Back to track</a>
      <h2 class="print-sidebar-title">Print Mode</h2>

      <label class="print-tree-item print-tree-track">
        <input type="checkbox" data-select-all />
        <span>Select all</span>
      </label>

      <div class="print-fields-section print-filter-section">
        <span class="print-fields-label">Quick select</span>
        <label class="print-tree-item">
          <input type="checkbox" data-progress-filter="completed" />
          <span>Completed</span>
        </label>
        <label class="print-tree-item">
          <input type="checkbox" data-progress-filter="highlighted" />
          <span>Highlighted</span>
        </label>
        <label class="print-tree-item">
          <input type="checkbox" data-progress-filter="incomplete" />
          <span>Incomplete</span>
        </label>
      </div>

      <div class="print-tree" id="print-tree">
        <!-- Built client-side -->
      </div>

      <div class="print-fields-section">
        <span class="print-fields-label">Show fields</span>
        <label class="print-tree-item"><input type="checkbox" data-field-toggle="description" checked /><span>Description</span></label>
        <label class="print-tree-item"><input type="checkbox" data-field-toggle="prerequisites" checked /><span>Prerequisites</span></label>
        <label class="print-tree-item"><input type="checkbox" data-field-toggle="outcomes" checked /><span>Outcomes</span></label>
        <label class="print-tree-item"><input type="checkbox" data-field-toggle="concepts" checked /><span>Concept Notes</span></label>
        <label class="print-tree-item"><input type="checkbox" data-field-toggle="resources" checked /><span>Resources</span></label>
      </div>

      <div class="print-fields-section">
        <span class="print-fields-label">Options</span>
        <label class="print-tree-item">
          <input type="checkbox" id="high-contrast-toggle" />
          <span>High contrast (no gray)</span>
        </label>
        <label class="print-tree-item">
          <input type="checkbox" id="section-breaks-toggle" />
          <span>New page per section</span>
        </label>
        <label class="print-tree-item print-select-item">
          <span>PDF links:</span>
          <select id="pdf-qr-mode">
            <option value="both">QR + URL</option>
            <option value="qr">QR only</option>
            <option value="url">URL only</option>
            <option value="hidden">Hidden</option>
          </select>
        </label>
        <label class="print-tree-item print-select-item">
          <span>Resource links:</span>
          <select id="resource-qr-mode">
            <option value="url" selected>URL only</option>
            <option value="both">QR + URL</option>
            <option value="qr">QR only</option>
            <option value="hidden">Hidden</option>
          </select>
        </label>
        <label class="print-tree-item">
          <input type="checkbox" id="show-fallback-url" checked />
          <span>Show fallback URL</span>
        </label>
      </div>

      <div class="print-layout-toggle">
        <span class="print-fields-label">Layout</span>
        <label class="print-tree-item">
          <input type="radio" name="print-layout" value="normal" checked data-layout-radio />
          <span>Normal (A4)</span>
        </label>
        <label class="print-tree-item">
          <input type="radio" name="print-layout" value="two-col" data-layout-radio />
          <span>2-column (A4)</span>
        </label>
        <label class="print-tree-item">
          <input type="radio" name="print-layout" value="booklet-duplex" data-layout-radio />
          <span>Booklet A5 (double-sided)</span>
        </label>
        <label class="print-tree-item">
          <input type="radio" name="print-layout" value="booklet-single" data-layout-radio />
          <span>Booklet A5 (single-sided)</span>
        </label>
      </div>

      <button class="btn print-btn" id="print-btn">Print / Save as PDF</button>

      <div class="booklet-workflow" id="booklet-workflow" hidden>
        <div class="booklet-step-block">
          <span class="booklet-step-badge">1</span>
          <div class="booklet-step-body">
            <p class="booklet-step-text">Save your content as an A5 PDF first. In the print dialog, choose <strong>"Save as PDF"</strong>.</p>
            <button class="btn print-btn" id="booklet-save-btn">Save as A5 PDF</button>
          </div>
        </div>
        <div class="booklet-step-block">
          <span class="booklet-step-badge">2</span>
          <div class="booklet-step-body">
            <p class="booklet-step-text">Select the saved PDF below. It will be rearranged into booklet page order and downloaded automatically.</p>
            <label class="btn print-btn booklet-upload-label" id="booklet-upload-label">
              Select A5 PDF &rarr; Download Booklet
              <input type="file" accept=".pdf" id="booklet-file-input" hidden />
            </label>
          </div>
        </div>
        <div class="booklet-status" id="booklet-status"></div>
      </div>
    </aside>

    <!-- Preview area -->
    <main class="print-preview">
      <div class="print-header" id="print-header">
        <h1 class="print-title" id="print-title">Loading...</h1>
        <p class="print-meta" id="print-meta"></p>
        <p class="print-url" id="print-url"></p>
      </div>

      <div class="print-empty-msg" id="print-empty-msg">
        Select items from the sidebar to preview them here.
      </div>

      <div id="print-content">
        <!-- Sections built client-side -->
      </div>
    </main>
  </div>

  <!-- Error state -->
  <div id="print-error" class="print-error-msg" hidden>
    <p>Custom track not found.</p>
    <a href="/roadmaps/" class="btn">&larr; Back to tracks</a>
  </div>
</PrintLayout>

<script>
  import { loadCustomContent } from '../../../lib/sync';
  import { initPrintCheckboxes, initFieldToggles, initHighContrastToggle, initSectionBreaksToggle, initLayoutMode, initProgressFilters, initPdfQrCodes, initResourceQrCodes, initQrDisplayOptions } from '../../../utils/printUtils';
  import { marked } from 'marked';
  import markedKatex from 'marked-katex-extension';

  // Configure marked for client-side parsing (no fs-dependent PDF manifest)
  marked.use(markedKatex({ throwOnError: false }));
  marked.use({
    renderer: {
      image({ href, title, text }: { href: string; title: string | null; text: string }) {
        if (!href) return '';
        const altText = text || '';
        const titleAttr = title ? ` title="${title}"` : '';
        if (href.toLowerCase().endsWith('.pdf')) {
          const encodedUrl = encodeURIComponent(href);
          return `<div class="notes-pdf-embed" data-pdf-url="${href}"><iframe src="/pdfjs/web/viewer.html?file=${encodedUrl}" title="${altText || 'PDF document'}" class="notes-pdf-iframe" loading="lazy"></iframe><div class="notes-pdf-resizer" title="Drag to resize PDF"></div></div>`;
        }
        return `<img src="${href}" alt="${altText}"${titleAttr} class="notes-image" loading="lazy" />`;
      }
    }
  });

  function escapeHtml(str: string): string {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function parseNotesClient(markdown: string): string {
    return marked.parse(markdown, { async: false }) as string;
  }

  async function init() {
    const params = new URLSearchParams(window.location.search);
    const slug = params.get('track');

    if (!slug) {
      showError();
      return;
    }

    // Set back link
    const backLink = document.getElementById('back-link') as HTMLAnchorElement;
    if (backLink) backLink.href = `/roadmaps/custom/?track=${slug}`;

    try {
      const content = await loadCustomContent();
      const track = content.tracks?.[slug];

      if (!track) {
        showError();
        return;
      }

      // Clean up null items
      track.sections = (track.sections || []).map((section: any) => ({
        ...section,
        items: (section.items || []).filter((item: any) => item !== null)
      }));

      const sections = track.sections;

      // Count totals
      let totalTopics = 0;
      let totalConcepts = 0;
      for (const section of sections) {
        totalTopics += section.items.length;
        for (const item of section.items) {
          totalConcepts += item.concepts?.length ?? 0;
        }
      }

      // Update header
      const titleEl = document.getElementById('print-title');
      const metaEl = document.getElementById('print-meta');
      const urlEl = document.getElementById('print-url');
      if (titleEl) titleEl.textContent = track.meta.title;
      if (metaEl) metaEl.textContent = `${sections.length} sections \u00b7 ${totalTopics} topics \u00b7 ${totalConcepts} concepts`;
      if (urlEl) urlEl.textContent = `eee-roadmap.muhammadhazimiyusri.uk/roadmaps/custom/?track=${slug}`;

      // Parse concept notes from track structure
      const conceptNotesMap: Record<string, Record<string, string>> = {};
      for (const section of sections) {
        for (const item of section.items) {
          if (item.concepts) {
            conceptNotesMap[item.id] = {};
            for (const concept of item.concepts) {
              if (concept.notes) {
                conceptNotesMap[item.id][concept.name] = parseNotesClient(concept.notes);
              }
            }
          }
        }
      }

      // Merge user-edited conceptNotes (overrides track structure notes)
      const savedNotes = content.conceptNotes || {};
      for (const [noteKey, markdown] of Object.entries(savedNotes)) {
        const parts = noteKey.split('/');
        if (parts[0] !== slug || parts.length < 3) continue;
        const topicId = parts[1];
        const conceptName = parts.slice(2).join('/');
        if (!conceptNotesMap[topicId]) conceptNotesMap[topicId] = {};
        conceptNotesMap[topicId][conceptName] = parseNotesClient(markdown as string);
      }

      // Build sidebar tree
      const tree = document.getElementById('print-tree')!;
      tree.innerHTML = sections.map((section: any) => `
        <div class="print-tree-section">
          <label class="print-tree-item print-tree-item--section">
            <input type="checkbox" data-section-check="${escapeHtml(section.id)}" />
            <span>${escapeHtml(section.title)}</span>
          </label>
          <div class="print-tree-children">
            ${section.items.map((item: any) => `
              <div class="print-tree-topic">
                <label class="print-tree-item print-tree-item--topic">
                  <input type="checkbox"
                    data-topic-check="${escapeHtml(item.id)}"
                    data-parent-section="${escapeHtml(section.id)}"
                  />
                  <span>${escapeHtml(item.title)}</span>
                </label>
                ${item.concepts && item.concepts.length > 0 ? `
                  <div class="print-tree-children">
                    ${item.concepts.map((c: any) => `
                      <label class="print-tree-item print-tree-item--concept">
                        <input type="checkbox"
                          data-concept-check="${escapeHtml(item.id)}:${escapeHtml(c.name)}"
                          data-parent-topic="${escapeHtml(item.id)}"
                          data-parent-section="${escapeHtml(section.id)}"
                        />
                        <span>${escapeHtml(c.name)}</span>
                      </label>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Build preview content
      const contentEl = document.getElementById('print-content')!;
      contentEl.innerHTML = sections.map((section: any) => `
        <div class="print-section" data-print-section="${escapeHtml(section.id)}" hidden>
          <h2 class="print-section-title">${escapeHtml(section.title)}</h2>
          ${section.items.map((item: any) => {
            const prereqs = (item.prerequisites || []).map((p: string) => {
              const parts = p.split('/');
              return parts.length >= 2
                ? (parts.length > 2 ? parts.slice(2).join('/') : parts[1].replace(/-/g, ' '))
                : p;
            });

            return `
              <div class="print-topic" data-print-topic="${escapeHtml(item.id)}" hidden>
                <h3 class="print-topic-title">
                  ${escapeHtml(item.title)}
                  ${item.optional ? '<span class="print-optional-badge">optional</span>' : ''}
                </h3>
                <p class="print-description" data-print-field="description">${escapeHtml(item.description || '')}</p>

                ${prereqs.length > 0 ? `
                  <div class="print-field" data-print-field="prerequisites">
                    <span class="print-field-label">Prerequisites:</span>
                    <span class="print-field-value">${prereqs.map(escapeHtml).join(', ')}</span>
                  </div>
                ` : ''}

                ${item.outcomes && item.outcomes.length > 0 ? `
                  <div class="print-field" data-print-field="outcomes">
                    <span class="print-field-label">You'll learn to:</span>
                    <ul class="print-outcomes">
                      ${item.outcomes.map((o: string) => `<li>${escapeHtml(o)}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}

                ${item.concepts && item.concepts.length > 0 ? `
                  <div class="print-concepts-area" data-print-field="concepts">
                    ${item.concepts.map((c: any) => `
                      <div class="print-concept" data-print-concept="${escapeHtml(item.id)}:${escapeHtml(c.name)}" hidden>
                        <span class="print-concept-name">${escapeHtml(c.name)}</span>
                        ${conceptNotesMap[item.id]?.[c.name] ? `
                          <div class="print-concept-notes">${conceptNotesMap[item.id][c.name]}</div>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}

                ${item.resources && item.resources.length > 0 ? `
                  <div class="print-field" data-print-field="resources">
                    <span class="print-field-label">Resources:</span>
                    <ul class="print-resources">
                      ${item.resources.map((r: any) => `
                        <li data-resource-url="${escapeHtml(r.url)}" data-topic-id="${escapeHtml(item.id)}">
                          <span class="print-resource-label">${escapeHtml(r.label)}</span>
                          <span class="print-resource-url">${escapeHtml(r.url)}</span>
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `).join('');

      // Set track metadata on print page for QR fallback URLs
      const printPage = document.querySelector<HTMLElement>('.print-page');
      if (printPage) {
        printPage.dataset.trackSlug = slug;
        printPage.dataset.trackType = 'custom';
      }

      // Wire up shared print interactions
      const { updateParentStates, updatePreview } = initPrintCheckboxes();
      initProgressFilters(updateParentStates, updatePreview);
      initFieldToggles();
      initHighContrastToggle();
      initSectionBreaksToggle();
      initLayoutMode();
      initPdfQrCodes();
      initResourceQrCodes();
      initQrDisplayOptions();

    } catch (err) {
      console.error('Failed to load custom track for print:', err);
      showError();
    }
  }

  function showError() {
    const page = document.getElementById('print-page');
    const error = document.getElementById('print-error');
    if (page) page.hidden = true;
    if (error) error.hidden = false;
  }

  init();
</script>

<style is:global>
  @import '../../../styles/print.css';
</style>
